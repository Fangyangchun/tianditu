var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(z){return typeof z}:function(z){return z&&"function"===typeof Symbol&&z.constructor===Symbol&&z!==Symbol.prototype?"symbol":typeof z};function _possibleConstructorReturn(z,g){if(!z)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!g||"object"!==typeof g&&"function"!==typeof g?z:g}function _inherits(z,g){if("function"!==typeof g&&null!==g)throw new TypeError("Super expression must either be null or a function, not "+typeof g);z.prototype=Object.create(g&&g.prototype,{constructor:{value:z,enumerable:!1,writable:!0,configurable:!0}});g&&(Object.setPrototypeOf?Object.setPrototypeOf(z,g):z.__proto__=g)}function _classCallCheck(z,g){if(!(z instanceof g))throw new TypeError("Cannot call a class as a function");}(function(z){"object"===("undefined"===typeof exports?"undefined":_typeof(exports))&&"undefined"!==typeof module?module.exports=z():"function"===typeof define&&define.amd?define([],z):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).Custom=z()})(function(){return function g(l,r,f){function c(a,d){if(!r[a]){if(!l[a]){var e="function"==typeof require&&require;if(!d&&e)return e(a,!0);if(b)return b(a,!0);e=Error("Cannot find module '"+a+"'");throw e.code="MODULE_NOT_FOUND",e;}e=r[a]={exports:{}};l[a][0].call(e.exports,function(d){var e=l[a][1][d];return c(e?e:d)},e,e.exports,g,l,r,f)}return r[a].exports}for(var b="function"==typeof require&&require,a=0;a<f.length;a++)c(f[a]);return c}({1:[function(g,l,r){g=L.extend({},L.CRS.Earth,{code:"EPSG:4326",projection:L.Projection.LonLat,transformation:new L.Transformation(1/180,1,-1/180,.5),scale:function(f){return 256*Math.pow(2,f-1)}});l.exports=g},{}],2:[function(g,l,r){L.Control.Attribution.prototype.options={position:"bottomright"};L.Map.TouchZoom.prototype._onTouchMove=function(f){return function(c){if(c.touches&&2===c.touches.length&&this._zooming){var b=this._map,a=b.mouseEventToContainerPoint(c.touches[0]),e=b.mouseEventToContainerPoint(c.touches[1]),d=a.distanceTo(e)/this._startDist;this._zoom=b.getScaleZoom(d,this._startZoom)+1;!b.options.bounceAtZoomLimits&&(this._zoom<b.getMinZoom()&&1>d||this._zoom>b.getMaxZoom()&&1<d)&&(this._zoom=b._limitZoom(this._zoom));if("center"===b.options.touchZoom){if(this._center=this._startLatLng,1===d)return}else{a=a._add(e)._divideBy(2)._subtract(this._centerPoint);if(1===d&&0===a.x&&0===a.y)return;this._center=b.unproject(b.project(this._pinchStartLatLng,this._zoom).subtract(a),this._zoom)}this._moved||(b._moveStart(!0),this._moved=!0);L.Util.cancelAnimFrame(this._animRequest);b=L.bind(b._move,b,this._center,this._zoom,{pinch:!0,round:!1});this._animRequest=L.Util.requestAnimFrame(b,this,!0);L.DomEvent.preventDefault(c)}}}(L.Map.TouchZoom.prototype._onTouchMove);L.Map.prototype.flyTo=function(f){return function(c,b,a){function e(a){a=(v*v-g*g+2.0164*(a?-1:1)*2.0164*l*l)/(4.0328*(a?v:g)*l);a=Math.sqrt(a*a+1)-a;return 1E-9>a?-18:Math.log(a)}function d(a){return(Math.exp(a)+Math.exp(-a))/2}function n(a){return g*(d(C)/d(C+1.42*a))}function p(a){var e=d(C);a=C+1.42*a;a=(Math.exp(a)-Math.exp(-a))/2/d(a);return g*(e*a-(Math.exp(C)-Math.exp(-C))/2)/2.0164}function h(){var a=(Date.now()-r)/y,d=(1-Math.pow(1-a,1.5))*u;1>=a?(this._flyToFrame=L.Util.requestAnimFrame(h,this),this._move(this.unproject(k.add(m.subtract(k).multiplyBy(p(d)/l)),t),this.getScaleZoom(g/n(d),t),{flyTo:!0})):(b=Math.round(b),this._move(c,b)._moveEnd(!0))}a=a||{};if(!1===a.animate||!L.Browser.any3d)return this.setView(c,b,a);this._stop();var k=this.project(this.getCenter()),m=this.project(c),f=this.getSize(),t=this._zoom;c=L.latLng(c);b=void 0===b?t:b;var g=Math.max(f.x,f.y),v=g*this.getZoomScale(t,b),l=m.distanceTo(k)||1,C=e(0),r=Date.now(),u=(e(1)-C)/1.42,y=a.duration?1E3*a.duration:800*u;this._moveStart(!0);h.call(this);return this}}(L.Map.prototype.flyTo);if(window.ActiveXObject||"ActiveXObject"in window)String.prototype.startsWith=function(f){return null==f||""==f||0==this.length||f.length>this.length||this.substr(0,f.length)!=f?!1:!0},String.prototype.endsWith=function(f){return window.ActiveXObject||"ActiveXObject"in window?-1!==this.indexOf(f,this.length-f.length):this.endsWith(f)}},{}],3:[function(g,l,r){l.exports="jssdk_bate@ leaflet 2.1.1"},{}],4:[function(g,l,r){g=function(){function f(){_classCallCheck(this,f);this.otherDisplay=!0;this.layers=[];this.order=[]}f.prototype.addFilterLayer=function(c){this.layers.push(c)};f.prototype.removeFilterLayerById=function(c){for(var b=0;b<this.layers.length;b++)this.layers[b].id==c&&this.layers.splice(b,1)};return f}();l.exports=g},{}],5:[function(g,l,r){g=function(f){function c(){_classCallCheck(this,c);var b=_possibleConstructorReturn(this,f.call(this));b.id=null;b.filters={};b.idFilter=null;b.filterStr=null;b.display=!0;return b}_inherits(c,f);c.prototype.addFilterField=function(b,a){this.filters[b]=a};c.prototype.removeFilterField=function(b){delete this.filters[b]};return c}(g("./Filter"));l.exports=g},{"./Filter":4}],6:[function(g,l,r){l=l.exports={};g("./ext/LeafletExt");L.CRS.CustomEPSG4326=g("./ext/CRS.CustomEPSG4326");l.DataSource=g("./layer/datasource/DataSource");l.URLDataSource=g("./layer/datasource/URLDataSource");l.LocalDataSource=g("./layer/datasource/LocalDataSource");L.GLabelGrid=g("./layer/label/GLabelGrid");L.GWVTAnno=g("./layer/label/GWVTAnno");l.Feature=g("./layer/label/feature/Feature");l.GGroup=g("./layer/vector/stylejs/GGroup");l.GLevels=g("./layer/vector/stylejs/GLevels");l.GStyleItem=g("./layer/vector/stylejs/GStyleItem");L.GDynamicMap=g("./layer/vector/GDynamicMap");L.GVMapGrid=g("./layer/vector/GVMapGrid");L.GXYZ=g("./layer/vector/GXYZ");l.GServiceGroup=g("./layer/GServiceGroup");l.GVMapGridUtil=g("./layer/vector/draw/GVMapGridUtil");l.Filter=g("./filter/Filter");l.FilterLayer=g("./filter/FilterLayer")},{"./ext/CRS.CustomEPSG4326":1,"./ext/LeafletExt":2,"./filter/Filter":4,"./filter/FilterLayer":5,"./layer/GServiceGroup":7,"./layer/datasource/DataSource":8,"./layer/datasource/LocalDataSource":9,"./layer/datasource/URLDataSource":10,"./layer/label/GLabelGrid":11,"./layer/label/GWVTAnno":12,"./layer/label/feature/Feature":22,"./layer/vector/GDynamicMap":23,"./layer/vector/GVMapGrid":24,"./layer/vector/GXYZ":25,"./layer/vector/draw/GVMapGridUtil":26,"./layer/vector/stylejs/GGroup":28,"./layer/vector/stylejs/GLevels":29,"./layer/vector/stylejs/GStyleItem":30}],7:[function(g,l,r){g=function(){function f(c,b,a,e){_classCallCheck(this,f);this.label=this.layer=this.map=null;this.layerType=0;this.labelType=2;this.map=a;this.url=b;this.layerId=c;this.styleId=null;this.tileSize=256}f.prototype.addServiceGroup=function(){options&&options.styleId&&(this.styleId=options.styleId);options&&options.tileSize&&(this.tileSize=options.tileSize);switch(this.layerType){case 0:this.addBaseLayer();break;case 1:this.addFrontBaseLayer()}switch(this.labelType){case 2:this.addFrontLabel();break;case 3:this.AddImgLabel();break;case 4:this.addAvoidLabel()}};f.prototype.addBaseLayer=function(){this.layer=new L.GXYZ(this.url+"\x26x\x3d{x}\x26y\x3d{y}\x26l\x3d{z}\x26tileType\x3d"+this.layerType,{sphericalMercator:!1,isBaseLayer:!1,tileSize:this.tileSize});this.map.addLayer(this.layer)};f.prototype.addFrontBaseLayer=function(){this.layer=new L.GVMapGrid(this.url+"\x26x\x3d{x}\x26y\x3d{y}\x26l\x3d{z}\x26tileType\x3d"+this.layerType,{maxZoom:21,keepBuffer:0,updateWhenZooming:!1,tileSize:this.tileSize});this.map.addLayer(this.layer)};f.prototype.AddImgLabel=function(){this.label=new L.GXYZ(this.url+"\x26x\x3d{x}\x26y\x3d{y}\x26l\x3d{z}\x26tileType\x3d"+this.labelType,{sphericalMercator:!1,isBaseLayer:!1,tileSize:this.tileSize});this.map.addLayer(this.label)};f.prototype.addAvoidLabel=function(c){this.label=new L.GLabelGrid(this.url+"\x26x\x3d{x}\x26y\x3d{y}\x26l\x3d{z}\x26tileType\x3d"+this.labelType,{hitDetection:!0,keepBuffer:0,updateWhenZooming:!1,tileSize:this.tileSize});this.map.addLayer(this.label)};f.prototype.addFrontLabel=function(c){this.label=new L.GWVTAnno("GWVTanno",{tileSize:this.tileSize});c=new Custom.URLDataSource;c.url=this.url+"\x26x\x3d${x}\x26y\x3d${y}\x26l\x3d${z}\x26tileType\x3d"+this.labelType;this.label.addDataSource(c);this.map.addLayer(this.label)};f.prototype.setLayerType=function(c){"Img"==c?this.layerType=0:"Data"==c&&(this.layerType=1)};f.prototype.setLabelType=function(c){"Data"==c?this.labelType=2:"Img"==c?this.labelType=3:"AvoidImg"==c&&(this.labelType=4)};f.prototype.setTileSize=function(c){this.tileSize=c};f.prototype.getLayer=function(){return this.layer};f.prototype.getLabel=function(){return this.label};f.prototype.removeGroupLayer=function(){this.layer&&this.map.removeLayer(this.layer);this.label&&this.map.removeLayer(this.label)};return f}();l.exports=g},{}],8:[function(g,l,r){var f=g("../../utils/UUID");l.exports=function b(){_classCallCheck(this,b);this.id=(new f).valueOf();this.type="";this.textures={}}},{"../../utils/UUID":32}],9:[function(g,l,r){g=function(f){function c(){_classCallCheck(this,c);var b=_possibleConstructorReturn(this,f.call(this));b.type="LocalDataSource";b.features=[];b.textureUrls={};return b}_inherits(c,f);c.prototype.addFeature=function(b){this.features.push(b)};c.prototype.addTextureUrl=function(b,a){this.textureUrls[b]=a};c.prototype.removeTextureUrl=function(b){delete this.textureUrls[b]};c.prototype.loadTexture=function(){var b=new Deferred,a=0,e;for(e in this.textureUrls)a++;if(0==a)b.resolve();else{var d=0,n;for(n in this.textureUrls)e=new Image,e.name=n,e.onload=function(e){d++;this.textures[e.target.name]=e.target;d==a&&b.resolve()}.bind(this),e.src=this.textureUrls[n];return b}};c.prototype.removeFeatureById=function(b){for(var a=0;a<this.features.length;a++)this.features[a].id==b&&this.features.splice(a,1)};return c}(g("./DataSource"));l.exports=g},{"./DataSource":8}],10:[function(g,l,r){r=g("./DataSource");var f=g("./../../utils/es6-promise"),c=f.Deferred,b=f.getJSON,a=g("../../ext/Version");g=function(e){function d(){_classCallCheck(this,d);var a=_possibleConstructorReturn(this,e.call(this));a.urlArray=[];a.type="URLDataSource";a.url=null;a.styleUrl=null;a.styleId="style";a.filter=null;a.textures={};a.control=null;a.controlId=null;a.sourceUrl=null;a.host="";a.servername="";return a}_inherits(d,e);d.prototype.loadStyle=function(d){var e=new c,n=new c,k=new c;this.parseUrl();this.sourceUrl||(this.sourceUrl=this.url+"\x26clientVersion\x3d"+a,this.url=this.url+"\x26clientVersion\x3d"+a);this.control&&this.isIE()?b({type:"post",url:this.host+"/mapserver/vmap/"+this.servername+"/setControl",data:"control\x3d"+this.control,dataType:"json"}).then(function(a){this.controlId=a.id;this.url=this.sourceUrl+"\x26controlId\x3d"+a.id;e.resolve()}.bind(this)):(this.url=this.control?this.sourceUrl+"\x26control\x3d"+this.control:this.sourceUrl,e.resolve());d||(d="label");b({url:this.host+"/mapserver/styleInfo/"+this.servername+"/"+this.styleId+"/"+d+"/style.js",dataType:"text"}).then(function(a){this.styleFun=new Function("drawer","level",a);n.resolve()}.bind(this));b({url:this.host+"/mapserver/styleInfo/"+this.servername+"/"+this.styleId+"/label/texture.js",dataType:"text"}).then(function(a){a=JSON.parse(a);var d=0,e;for(e in a)d++;if(0==d)k.resolve();else{var b=0,n;for(n in a)e=new Image,e.name=n,e.onload=function(a){b++;this.textures[a.target.name]=a.target;b==d&&k.resolve()}.bind(this),e.src=a[n]}}.bind(this));return[e,n,k]};d.prototype.parseUrl=function(){var a=this.url.split("?"),d=a[0].split("/mapserver/");this.host=d[0];this.servername=d[1].split("/")[1];a=a[1].split("\x26");for(d=0;d<a.length;d++){var e=a[d].split("\x3d");if("styleId"==e[0]){this.styleId=e[1];break}}};d.prototype.setFilter=function(a){this.control=null;if(this.url&&a&&(0!=a.layers.length||0!=a.order.length)){for(var d=0;d<a.layers.length;d++)a.layers[d].id||a.layers.splice(d,1);this.control=JSON.stringify(a)}};d.prototype.getTexture=function(a){return this.textures[a]};d.prototype.addTexture=function(a,d){this.textures[a]=d};d.prototype.isIE=function(){return window.ActiveXObject||"ActiveXObject"in window?!0:!1};return d}(r);l.exports=g},{"../../ext/Version":3,"./../../utils/es6-promise":33,"./DataSource":8}],11:[function(g,l,r){var f=g("../vector/draw/GXYZUtil"),c=g("../../ext/Version"),b=g("./avoid/GDrawGeomerty");g=L.TileLayer.extend({urlArray:[],sourceUrl:null,textures:{},tileQueue:[],ratio:1,tilesize:256,control:null,controlId:null,hitDetection:!1,initialize:function(a,e){1.5<window.devicePixelRatio&&(this.ratio=2);this.sourceUrl||(this.sourceUrl=a);e&&e.tileSize&&(this.tilesize=e.tileSize);this.gxyzUtil=new f;this.gxyzUtil.tileSize=this.tilesize;this.gxyzUtil.parseUrl(a);this._url=a+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c;L.setOptions(this,e);this.hitDetection=e.hitDetection;this.on("tileunload",this._onTileRemove);this.on("tileload",this._onTileLoad);this.on("tileerror",this._onTileError)},_initContainer:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-pane leaflet-overlay-pane"),this.getPane().appendChild(this._container))},onAdd:function(){this.control&&(this._url=this.sourceUrl+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26control\x3d"+this.control);this.controlId&&(this._url=this.sourceUrl+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26controlId\x3d"+this.controlId);this._initContainer();this._levels={};this._tiles={};Custom.getJSON({url:this.gxyzUtil.host+"/mapserver/styleInfo/"+this.gxyzUtil.servername+"/"+this.gxyzUtil.styleId+"/label/texture.js",dataType:"text"}).then(function(a){a=JSON.parse(a);var e=0,d;for(d in a)e++;0==e&&(this._resetView(),this._update());var b=0,c;for(c in a)d=new Image,d.name=c,d.onload=function(a){b++;this.textures[a.target.name]=a.target;b==e&&(this._resetView(),this._update())}.bind(this),d.src=a[c]}.bind(this))},createTile:function(a,e){var d=this.tileQueue.pop();d?this._cleanTile(d):d=this.initTile();var b=this.getTileUrl(a);Custom.getJSON({url:b,dataType:"json"}).then(function(a){d.data=a;this._tileOnLoad.apply(this,[e,d])}.bind(this),function(a){this._tileOnError.apply(this,[e,d,a])}.bind(this));return d},getTileUrl:function(a){var e={r:L.Browser.retina?"@2x":"",s:this._getSubdomain(a),x:a.x,y:a.y,z:this._getZoomForUrl()};this._map&&!this._map.options.crs.infinite&&(a=this._globalTileRange.max.y-a.y,this.options.tms&&(e.y=a),e["-y"]=a);if(0==this.urlArray.length)return L.Util.template(this._url,L.extend(e,this.options));a=this.urlArray[Math.round(Math.random()*(this.urlArray.length-1))];var d=this._url.split("/mapserver")[1];return L.Util.template(a+"/mapserver"+d,L.extend(e,this.options))},initTile:function(){var a=document.createElement("canvas");a.style.width=this.tilesize+"px";a.style.height=this.tilesize+"px";a.width=this.tilesize;a.height=this.tilesize;var e=a.getContext("2d",{isQuality:!0});a.ctx=e;this.hitDetection&&(e=document.createElement("canvas"),e.style.width=this.tilesize+"px",e.style.height=this.tilesize+"px",e.width=this.tilesize,e.height=this.tilesize,e=e.getContext("2d",{isQuality:!0}),a.hitCtx=e);return a},_onTileRemove:function(a){this.tileQueue.push(a.tile)},_abortLoading:function(){var a,e;for(a in this._tiles)this._tiles[a].coords.z!==this._tileZoom&&(e=this._tiles[a].el,L.DomUtil.remove(e))},_onTileLoad:function(a){a=a.tile;this._drawTile(a,a.data);a.complete=!0},_onTileError:function(a){a=a.tile;a.complete=!0;this.tileQueue.push(a)},_tileOnError:function(a,e,d){a(d,e)},_drawTile:function(a,e){for(var d=a.ctx,n={},c=0;c<e.length;c++){var h=e[c];1==h.type?(h.id=Math.round(16777216*Math.random()),n[h.id]=h,h.iconImg=this.textures[h.style.texture],b.drawPointIcon(d,h,this.ratio,!1,a.hitCtx,this.hitDetection),b.drawPoint(d,h,this.ratio,!1,!1,a.hitCtx,this.hitDetection)):2==h.type&&b.drawLine(d,h,this.ratio)}a.featureIdMap=n},_cleanTile:function(a){a.ctx.clearRect(0,0,this.tilesize,this.tilesize);a.hitCtx&&a.hitCtx.clearRect(0,0,this.tilesize,this.tilesize)},getFeatureByXY:function(a,e){var d=null;if(this.hitDetection){var b=this._map.containerPointToLatLng(new L.point(a,e)),c=this._map.options.crs.projection.bounds,h=this._map.getBounds(),k=this._map.getPixelBounds(),f=(h._northEast.lat-h._southWest.lat)/(k.max.y-k.min.y),h=this.tilesize,k=(c.max.y-b.lat)/(f*h),c=(b.lng-c.min.x)/(f*h),f=Math.floor(k),q=Math.floor(c),b=this._map.getZoom(),b=this._tiles[q+":"+f+":"+b].el,h=b.hitCtx.getImageData((c-q)*h,(k-f)*h,1,1).data;if(255===h[3]&&(h=h[2]+256*(h[1]+256*h[0])))try{d=b.featureIdMap[h-1]}catch(t){}}return d},setFilter:function(a){this._url&&a&&(0!=a.layers.length||0!=a.order.length)&&this.gxyzUtil.setFilter(a,function(a){a.isIE?(this.controlId=a.id,this.setUrl(this.sourceUrl+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26controlId\x3d"+a.id)):(this.control=a.id,this.setUrl(this.sourceUrl+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26control\x3d"+a.id))}.bind(this))}});l.exports=g},{"../../ext/Version":3,"../vector/draw/GXYZUtil":27,"./avoid/GDrawGeomerty":16}],12:[function(g,l,r){var f=g("./draw/CanvasLayer");g=L.Layer.extend({canvasLayer:null,currLevel:2,ratio:1,hitDetection:!0,options:{tileSize:256,opacity:1},initialize:function(c){L.setOptions(this,c);this.options.hasOwnProperty("hitDetection")&&(this.hitDetection=this.options.hitDetection);1.5<window.devicePixelRatio&&(this.ratio=2);this.canvasLayer=new f;this.canvasLayer.tileSize=this.options.tileSize;this.canvasLayer.hitDetection=this.hitDetection;this.canvasLayer.ratio=this.ratio;this.animating=!1},onAdd:function(){var c=this._map.options.crs.projection.bounds;this.canvasLayer.init(this._map._size.x,this._map._size.y,this.options.tileSize,this);this.canvasLayer.maxExtent=[c.min.x,c.min.y,c.max.x,c.max.y];this._container=this.canvasLayer.root;this._zoomAnimated&&L.DomUtil.addClass(this._container,"leaflet-zoom-animated");this.canvasLayer.root.style.opacity=this.options.opacity;this.getPane().appendChild(this.canvasLayer.root);this._update()},setOpacity:function(c){this.options.opacity=c;this.canvasLayer.root&&(this.canvasLayer.root.style.opacity=this.options.opacity)},getEvents:function(){var c={resize:this.onResize,movestart:this.onMoveStart,zoom:this._onZoom,moveend:this._onMoveend};this._zoomAnimated&&(c.zoomanim=this._onAnimZoom);return c},onResize:function(c){this.canvasLayer.tileSize=this.options.tileSize;this.canvasLayer.gwvtAnno=this;this.canvasLayer.initCanvas(this._map._size.x,this._map._size.y);this._update()},_onAnimZoom:function(c){this.updateTransform(c.center,c.zoom)},_onZoom:function(){this.updateTransform(this._map.getCenter(),this._map.getZoom())},_onMoveend:function(){this.animating=!1;this._update()},updateTransform:function(c,b){this._zoom&&this._center||(this._zoom=this._map.getZoom(),this._center=this._map.getCenter());var a=this._map.getZoomScale(b,this._zoom),e=this.getCanvasXY(),d=this._map.getSize().multiplyBy(.5),n=this._map.project(this._center,b),n=this._map.project(c,b).subtract(n),e=d.multiplyBy(-a).add(e).add(d).subtract(n);L.Browser.any3d?L.DomUtil.setTransform(this.canvasLayer.root,e,a):L.DomUtil.setPosition(this.canvasLayer.root,e)},onMoveStart:function(){this.animating=!0},_update:function(){var c=this._map;if(c){var b=c.getBounds(),a=c.getPixelBounds(),a=(b._northEast.lat-b._southWest.lat)/(a.max.y-a.min.y),e=c.options.crs.projection.bounds,d=Math.floor((e.max.y-b._northEast.lat)/(a*this.options.tileSize)),n=Math.ceil((e.max.y-b._southWest.lat)/(a*this.options.tileSize)),p=Math.floor((b._southWest.lng-e.min.x)/(a*this.options.tileSize)),e=Math.ceil((b._northEast.lng-e.min.x)/(a*this.options.tileSize)),c=c.getZoom(),h=this.currLevel!=c,d=this.getGrid(d,n,p,e,c);this.canvasLayer.extent=[b._southWest.lng,b._southWest.lat,b._northEast.lng,b._northEast.lat];this.canvasLayer.res=a;this.canvasLayer.requestLabelTiles(d,h);this.currLevel=c}},getGrid:function(c,b,a,e,d){for(var n=[];a<e;a++)for(var p=c;p<b;p++)n.push({row:p,col:a,level:d});return n},resetCanvasDiv:function(){var c=this.getCanvasXY();L.DomUtil.setPosition(this._container,c);this._center=this._map.getCenter();this._zoom=this._map.getZoom()},getCanvasXY:function(){if(this._map){var c=this._map.dragging._draggable._element.style.transform.match(/(-?\d+\.?\d*)(px)/g),b=c[0].replace("px",""),c=c[1].replace("px","");return{x:-b,y:-c}}},redraw:function(){this.canvasLayer&&this.canvasLayer.redraw()},addDataSource:function(c){this.canvasLayer.addDataSource(c)},removeDataSourceById:function(c){this.canvasLayer.removeDataSourceById(c)},onRemove:function(c){L.DomUtil.remove(this.canvasLayer.root)},addToMap:function(c){c.addLayer(this)},getFeatureByXY:function(c,b){return this.canvasLayer.getFeatureByXY(c,b)},setHasImportant:function(c){this.canvasLayer&&(this.canvasLayer.hasImportant=c)},getHasImportant:function(){return this.canvasLayer?this.canvasLayer.hasImportant:!0},CLASS_NAME:"OpenLayers.Layer.GWVTAnno"});l.exports=g},{"./draw/CanvasLayer":20}],13:[function(g,l,r){var f=g("./GGridIndex"),c=g("./GLabelBox");g=function(){function b(a,e){_classCallCheck(this,b);this.grid=null;this.GLabelBox=new c(a,e)}b.prototype.avoid=function(a,e){if(0==e.length)return a;for(var d=0;d<a.length;d++){var b=a[d];1==b.type&&this.avoidPointLine(b,e);2==b.type&&(b.isCollision=this.avoidLineLine(b,e))}return a};b.prototype.avoidPointLine=function(a,e){var d=a.style.direction;e=this.getAvoidLineFeatures(a.weight,e);for(var b=0,c=a.boxs.length,h=0;h<e.length;h++)for(var k=e[h],f=0;f<c;f++){var q=d+f;q>=c&&(q-=c);if(this.crashBoxLine(a.boxs[q],k.sourceDatas,!1)&&a.directions[q]&&(delete a.directions[q],b++,4==b))return!0}return!1};b.prototype.avoidLineLine=function(a,e){e=this.getAvoidLineFeatures(a.weight,e);for(var d=0;d<e.length;d++)for(var b=e[d],c,h=0;h<a.boxs.length;h++)if(c=this.crashPartLineLine(a.boxs[h],b.sourceDatas))return!0;return!1};b.prototype.getAvoidLineFeatures=function(a,e){for(var d=[],b=0;b<e.length;b++){var c=e[b];c.weight>a&&d.push(c)}return d};b.prototype.crashBoxLine=function(a,e,d){var b=[];d?(b.push([a[0],a[1],a[2],a[1]]),b.push([a[2],a[1],a[2],a[3]]),b.push([a[2],a[3],a[0],a[3]]),b.push([a[0],a[3],a[0],a[1]])):(b.push([a[0],a[1],a[2],a[3]]),b.push([a[2],a[1],a[0],a[3]]));for(a=0;a<b.length;a++){d=b[a];for(var c=0;c<e.length/2-1;c++)if(this.crashPartLinePartLine(d,[e[2*c],e[2*c+1],e[2*(c+1)],e[2*(c+1)+1]]))return!0}return!1};b.prototype.crashLineLine=function(a,e){for(var d=0;d<a.length/2-1;d++)for(var b=[a[2*d],a[2*d+1],a[2*(d+1)],a[2*(d+1)+1]],c=0;c<e.length/2-1;c++)if(this.crashPartLinePartLine(b,[e[2*c],e[2*c+1],e[2*(c+1)],e[2*(c+1)+1]]))return!0;return!1};b.prototype.crashPartLineLine=function(a,e){for(var d=0;d<e.length/2-1;d++)if(this.crashPartLinePartLine(a,[e[2*d],e[2*d+1],e[2*(d+1)],e[2*(d+1)+1]]))return!0;return!1};b.prototype.crashPartLinePartLine=function(a,e){var d=a[0],b=a[1],c=a[3],h=e[0],k=e[1],f=e[2],q=e[3],t,g;t=a[2]-d;c-=b;f-=h;g=q-k;q=t*g-f*c;if(0==q)return 0;var v=0<q,d=d-h,b=b-k;t=t*b-c*d;if(0>t==v)return 0;b=f*b-g*d;return 0>b==v||t>q==v||b>q==v?0:1};b.prototype.defaultAvoid=function(a,e){this.grid=new f(8192,16,0);if(null==a||1>a.length)return[];a=this.GLabelBox.setBox(a,!1);a=this.mergeFeatures(a);this.sort(a,e);for(var d=0;d<a.length;d++)this.avoidFeature(a[d]);a=this.GLabelBox.filterFeature(a);this.removeRepeat(a);return this.prevFeatures=a=this.filterFeature(a)};b.prototype.avoidFeature=function(a){0==a.style.show||1==a.hidden?a.hidden=!0:a.boxs?1==a.type?this.avoidPoint(a):a.isCollision?a.hidden=!0:this.avoidLine(a):a.hidden=!0};b.prototype.avoidPoint=function(a){if(1==a.style.isImportant)this.addBoxToCells(a.primaryId,a.boxs[a.style.direction]);else if(a.style.isFourDirections&&a.style.texture)this.addFourCollisionFeatureToCells(a,a.style.direction);else if(a.directions[a.style.direction]){var e=a.boxs[a.style.direction];this.isCollision(e)?a.hidden=!0:this.addBoxToCells(a.primaryId,e)}else a.hidden=!0};b.prototype.avoidLine=function(a){if(1==a.style.isImportant)for(var e=0;e<a.boxs.length;e++)this.addBoxToCells(a.primaryId+"index_"+e,a.boxs[e]);else{for(var e=!1,d=0;d<a.boxs.length;d++)if(this.isCollision(a.boxs[d])){e=!0;break}if(e)a.hidden=!0;else for(e=0;e<a.boxs.length;e++)this.addBoxToCells(a.primaryId+"index_"+e,a.boxs[e])}};b.prototype.addFourCollisionFeatureToCells=function(a,e){var d=!0,b=[];a.directions[e]&&(b=a.boxs[e],d=this.isCollision(b));d?(e++,4==e&&(e-=4),e==a.style.direction?a.hidden=!0:this.addFourCollisionFeatureToCells(a,e)):(a.style.textPoint=a.fourPoints[e],this.addBoxToCells(a.primaryId,b))};b.prototype.isCollision=function(a){return 0<this.grid.query(a[0],a[1],a[2],a[3]).length};b.prototype.addBoxToCells=function(a,e){this.grid.insert(a,e[0],e[1],e[2],e[3])};b.prototype.mergeFeatures=function(a){for(var e={},d=0;d<a.length;d++){var b=a[d];e[b.attributeId]||(e[b.attributeId]=[]);e[b.attributeId].push(b)}for(var c in e)if(d=e[c],1<d.length){b=d[0];if("1"==b.type){for(var h=d[0].directions,k=1;k<d.length;k++)h=this.getBothDirection(h,d[k].directions);var k=!1,f;for(f in h){k=!0;break}for(var q=0;q<d.length;q++)k?d[0].hidden=!0:d[0].directions=h}if("2"==b.type){b=!1;for(h=0;h<d.length;h++)if(1==d[h].isCollision){b=!0;break}if(b)for(b=0;b<d.length;b++)d[b].hidden=!0}}return this.GLabelBox.filterFeature(a)};b.prototype.sort=function(a,e){if(0<a.length)return a.sort(function(a,b){if(e){if(a.style.isImportant&&!b.style.isImportant)return-1;if(b.style.isImportant&&!a.style.isImportant)return 1}var d=a.weight,c=b.weight,n=a.primaryId,f=b.primaryId;d||(d=-1);c||(c=-1);return d<c?1:d==c?n<f?1:-1:-1}.bind(this))};b.prototype.getBothDirection=function(a,e){var d={},b;for(b in a)e[b]&&(d[b]=1);return d};b.prototype.removeRepeat=function(a){for(var e=[],d=[],b=[],c=[],h=[],k=[],f=0;f<a.length;f++){var q=a[f];1==q.type?1==q.drawed?c.push(q):e.push(q):2==q.type&&("text"==q.lineType&&(1==q.drawed?h.push(q):d.push(q)),"code"==q.lineType&&(1==q.drawed?k.push(q):b.push(q)))}for(a=0;a<e.length;a++)this.getShowPointFeatrues(c,e[a]);for(e=0;e<d.length;e++)this.getShowLineTextFeatrues(h,d[e]);for(d=0;d<b.length;d++)this.getShowLineCodeFeatrues(k,b[d]);if(this.prevFeatures)for(b=0;b<this.prevFeatures.length;b++)this.prevFeatures[b].drawed=!1};b.prototype.getShowPointFeatrues=function(a,e){for(var d=!1,b=0;b<a.length;b++){var c=a[b];c.label==e.label&&c.style.distance&&e.style.distance&&this.getDistance(c.style.textPoint,e.style.textPoint)<c.style.distance&&(d=!0,e.hidden=!0)}d||a.push(e)};b.prototype.getShowLineTextFeatrues=function(a,b){for(var d=!1,e=0;e<a.length;e++){var c=a[e];c.label==b.label&&c.style.lineTextDistance&&b.style.lineTextDistance&&this.getDistance(c.centerPoint,b.centerPoint)<c.style.lineTextDistance&&(d=!0,b.hidden=!0)}d||a.push(b)};b.prototype.getShowLineCodeFeatrues=function(a,b){for(var d=!1,e=0;e<a.length;e++){var c=a[e];c.label==b.label&&c.style.lineCodeDistance&&b.style.lineCodeDistance&&this.getDistance(c.centerPoint,b.centerPoint)<c.style.lineCodeDistance&&(d=!0,b.hidden=!0)}d||a.push(b)};b.prototype.getDistance=function(a,b){var d=b[0]-a[0],e=b[1]-a[1];return Math.pow(d*d+e*e,.5)};b.prototype.filterFeature=function(a){for(var b=[],d=0;d<a.length;d++)a[d].hidden||(a[d].drawed=!0,b.push(a[d]));return b};return b}();l.exports=g},{"./GGridIndex":17,"./GLabelBox":18}],14:[function(g,l,r){var f=g("./GDistance"),c=g("./Util");g=function(){function b(){_classCallCheck(this,b)}b.cutLineFeature=function(a){var b=[],d;if(4>a.sourceData.length)return b;var c=this.createLineTextFeatrue(a,0);d=c.index;c.feature&&b.push(c.feature);c=this.createLineCodeFeatrue(a,d);d=c.index;c.feature&&b.push(c.feature);a=this.createLineArrowFeatrue(a,d);a.feature&&b.push(a.feature);return b};b.createLineTextFeatrue=function(a,b){var d=a.style,e=a.sourceData,p=new f,h=[],k=null;if(c.isNotNull(a.label)){a.label+="";for(var m=0;m<a.label.length+1;m++)h.push(1.2*d.lineHeight+2+d.gap);m=[].concat(h);h=p.getNodePath(e,h);p=h.pointList;if(1<p.length){b=h.index;var h=!1,q=a.label.length>p.length?p.length-1:a.label.length-1,t=[p[0][0][0],p[0][0][1]],g=p[q][0],v=c.getAngle(t,g),k=this.cloneFeature(a);k.angle=v;0!=d.changeDirection&&(h=this.isChangeDirection(a.label,t,g,v))&&(p=this.changeDirection(e,p,m,b,q));k.attributeId+="_text";k.sourceAngleData=p;k.lineType="text";p.length<a.label.length&&(b=a.sourceData.length,p.length>.5*a.label.length?this.delayTextPoint(e,p,a.label,d.chinaLabelWidth+d.gap,h):k=null)}else d.showRoadCode||(k=this.cloneFeature(a),k.attributeId+="_text",k.sourceAngleData=[[[e[0],e[1]],0]],k.lineType="text",b=2)}return{feature:k,index:b}};b.createLineCodeFeatrue=function(a,b){var d=a.style,e=a.sourceData,p=new f,h=[],k=null,m=a.roadCodeLabel;return d.showRoadCode&&c.isNotNull(m)&&b<e.length&&(d=e.slice(b,e.length-1),h.push(30),p=p.getNodePath(d,h),h=p.pointList,1==h.length&&(b+=p.index,k=this.cloneFeature(a),k.attributeId+="_code",k.sourceAngleData=h,k.lineType="code",k.label=m+""),0==h.length)?(k=this.cloneFeature(a),k.attributeId+="_code",k.sourceAngleData=[[e,0]],k.lineType="code",k.label=m+"",{feature:k,index:2}):{feature:k,index:b}};b.createLineArrowFeatrue=function(a,b){var d=a.style,e=a.sourceData,c=new f,h=[],k=null;d.showArrow&&b<e.length&&(d=e.slice(b,e.length-1),h.push(16),h.push(16),c=c.getNodePath(d,h).pointList,2==c.length&&(k=this.cloneFeature(a),k.attributeId+="_arrow",k.sourceAngleData=c,k.lineType="arrow"));return{feature:k,index:b}};b.delayTextPoint=function(a,b,d,c,p){a=1==b.length?p?[a[a.length-2],a[a.length-1]]:[a[0],a[1]]:b[b.length-2][0];p=b[b.length-1][0];for(var e=b[b.length-1][1],n=b.length,f=1;f<d.length-n+1;f++){var q=[this.getPoint(a,p,c*f),e];b.push(q)}};b.cloneFeature=function(a){return{type:a.type,datas:a.datas,sourceData:a.sourceData,label:a.label,roadCodeLabel:a.roadCodeLabel,attributeId:a.attributeId,style:a.style,textures:a.textures,xyz:a.xyz,lineType:a.lineType,weight:a.weight,attributes:a.attributes}};b.changeDirection=function(a,b,d,c,p){c=c>=a.length?a.length:c;c=a.slice(0,c);a=[];for(var e=0;e<c.length-1;e++)a.push([c[e],c[e+1]]),e++;a=a.reverse();b=b[p][0];c=[b[0],b[1]];for(b=0;b<a.length;b++)c.push(a[b][0]),c.push(a[b][1]);return b=(new f).getNodePath(c,d).pointList};b.isChangeDirection=function(a,b,d,c){var e=!1;if(/.*[\u4e00-\u9fa5]+.*$/.test(a)){if(b[0]==d[0]&&b[1]>d[1])return!0;-45>c&&-90<c?b[0]<d[0]&&(e=!0):b[0]>d[0]&&(e=!0)}else b[0]>d[0]&&(e=!0);return e};b.getDistance=function(a,b){var d=b[0]-a[0],e=b[1]-a[1];return Math.pow(d*d+e*e,.5)};b.getLineDistance=function(a){if(4>a.length)return 0;for(var b=0,d=0;d<a.length/2-1;d++)b+=this.getDistance([a[2*d],a[2*d+1]],[a[2*(d+1)],a[2*(d+1)+1]]);return b};b.getPoint=function(a,b,d){var e=b[0]-a[0],c=b[1]-a[1];a=b[0];0==e?b=0<c?b[1]+d:b[1]-d:(d=Math.sqrt(d*d/(c/e*(c/e)+1)),0>e&&(d=-d),a=b[0]+d,b=b[1]+c/e*d);return[a,b]};return b}();l.exports=g},{"./GDistance":15,"./Util":19}],15:[function(g,l,r){g=function(){function f(){_classCallCheck(this,f)}f.prototype.getLengthPoint=function(c,b,a,e,d,n){var f=a-c;e-=b;if(0==f)return c=a,b=0<e?b+d:b-d,null==n?[c,b]:[c,b,n];a=e/f;d=Math.abs(d/Math.sqrt(a*a+1));a=Math.abs(d*a);c=0<f?c+d:c-d;b=0<e?b+a:b-a;return null==n?[c,b]:[c,b,n]};f.prototype.getAngle=function(c,b){return 0==b[0]-c[0]?b[1]>c[0]?90:-90:360*Math.atan((b[1]-c[1])/(b[0]-c[0]))/(2*Math.PI)};f.prototype.length=function(c,b,a,e){c=a-c;b=e-b;return Math.sqrt(c*c+b*b)};f.prototype.getNodePath=function(c,b){for(var a=[],e={},d=[],n=b.length,f=function(a){var b=a[0];a.splice(0,1);return b},h=f(b),k=0;;){if(d.length==n||k>=c.length)return e.index=k,e.pointList=d,e;var m=c[k],q=c[k+1];if(0==a.length)a[0]=m,a[1]=q;else{var t=this.length(a[0],a[1],m,q);t>=h?(h=this.getLengthPoint(a[0],a[1],m,q,h,null),m=this.getAngle(a,[m,q]),90==m&&(m=0),-90==m&&(m=0),0==m&&(m=.5),45<=m?m-=90:-45>=m&&(m+=90),d.push([h,m]),a[0]=h[0],a[1]=h[1],h=f(b)):(h-=t,a[0]=m,a[1]=q,k+=2)}}};return f}();l.exports=g},{}],16:[function(g,l,r){r=g("../../../utils/gistools/BoxSet");var f=new r(0,512,0,512,512,5),c=new r(0,256,0,256,256,5),b=g("../../../utils/gistools/GisTools"),a=g("./Util");g=function(){function e(){_classCallCheck(this,e)}e.draw=function(a,b,e,c,f,m,q){var d=null;c&&(d=new Map);for(c=0;c<b.length;c++){var h=b[c];1==h.type?(this.drawPointIcon(a,h,e,d,m,q),this.drawPoint(a,h,e,d,f,m,q)):2==h.type&&this.drawLine(a,h,e,d,f,m,q)}};e.drawPointIcon=function(a,b,e,c,f,m){var d=b.style;if(d.texture){var h=d.graphicWidth,n=d.graphicHeight,k=b.iconImg;if(k){h&&n||(h=k.width,n=k.height,c&&(h/=e,n/=e));var p=d.graphicXOffset-.5*h,g=d.graphicYOffset-.5*n,l=d.pointOffsetX,r=d.pointOffsetY;l||(l=0);r||(r=0);var y=[b.datas[0][0][0],b.datas[0][0][1]];y[0]+=l;y[1]+=r;p=y[0]+p;g=y[1]+g;y=d.pointFillAlpha||1;if(c)if(d=d.texture+"_"+p+"_"+g,null==c.get(d))c.set(d,!0);else return;a.save();a.globalAlpha=y;a.drawImage(k,p*e,g*e,h*e,n*e);a.restore();m&&(f.save(),this.setHitContextStyle(f,b.id),f.fillRect(p,g,h,n),f.restore())}}};e.drawPoint=function(d,e,c,h,f,m,g){if(e.label){var n=e.style,k=n.textPoint;if(h){var p=b.boxToPolyArr(e.box[0],e.box[1],e.box[2],e.box[3]),q=void 0;512==d.canvas.width/c?q=b.boxToPolyArr(-20,-20,532,532):256==d.canvas.width/c&&(q=b.boxToPolyArr(-15,-15,271,271));if(3==b.polyWith(q,p))return;p=e.label+"_"+k[0]+"_"+k[1];if(null==h.get(p))h.set(p,!0);else return}h=e.label.split(" ");var p=h.length,q=n.pointHeight,q=q+2,l=a.formatFont(n.pointFillFont,c,f);f=a.formatFont(n.pointStrokeFont,c,f);if(1==n.pointHashBackground){d.save();d.globalAlpha=n.pointBackgroundAlpha;d.strokeStyle=n.pointBackgroundLineColor;d.lineWidth=n.pointBackgroundLineWidth;d.fillStyle=n.pointBackgroundColor;d.font=n.pointFillFont;for(var r=k[0]-n.pointBackgroundGap,u=k[1]-n.pointBackgroundGap-n.pointHeight/2,y=0,w=0;w<p;w++){var x=d.measureText(h[w]).width;x>y&&(y=x)}this.drawRoundRect(d,r,u,y+2*n.pointBackgroundGap,n.pointHeight*p+2*n.pointBackgroundGap+2*(p-1),n.pointBackgroundRadius,c);d.fill();d.restore();for(w=0;w<p;w++)1==n.pointHashOutline&&(d.save(),d.textBaseline="middle",d.globalAlpha=n.pointStrokeAlpha,d.strokeStyle=n.pointStrokeStyle,d.lineWidth=n.pointLineWidth,d.font=f,d.strokeText(h[w],k[0]*c,(k[1]+q*w)*c),d.restore()),d.save(),d.textBaseline="middle",d.globalAlpha=n.pointFillAlpha,d.fillStyle=n.pointFillStyle,d.font=l,d.fillText(h[w],k[0]*c,(k[1]+q*w)*c),d.restore();g&&(m.save(),this.setHitContextStyle(m,e.id),this.drawHitRoundRect(m,r,u,y+2*n.pointBackgroundGap,n.pointHeight+2*n.pointBackgroundGap,n.pointBackgroundRadius),m.fill(),m.restore())}else{for(u=r=0;u<p;u++)1==n.pointHashOutline&&(d.save(),d.textBaseline="middle",d.globalAlpha=n.pointStrokeAlpha,d.strokeStyle=n.pointStrokeStyle,d.lineWidth=n.pointLineWidth,d.font=f,d.strokeText(h[u],k[0]*c,(k[1]+q*u)*c),d.restore()),d.save(),d.textBaseline="middle",d.globalAlpha=n.pointFillAlpha,d.fillStyle=n.pointFillStyle,d.font=l,d.fillText(h[u],k[0]*c,(k[1]+q*u)*c),r=d.measureText(h[u]).width>r?d.measureText(h[u]).width:r,d.restore();g&&(m.save(),this.setHitContextStyle(m,e.id),m.textBaseline="middle",m.fillRect(k[0],k[1]-n.pointHeight/2,r,q*p),m.restore())}}};e.drawLine=function(a,b,e,c,f,m,q){"text"==b.lineType&&this.drawLineText(a,b,e,c,f,m,q);"code"==b.lineType&&this.drawLineCode(a,b,e,c,f,m,q);"arrow"==b.lineType&&this.drawLineArrow(a,b,e,c,m,q)};e.drawLineText=function(b,e,p,h,k,m,q){var d=e.style,n=e.label,g=e.textPoints,l=void 0;h&&(512==b.canvas.width/p?l=f:256==b.canvas.width/p&&(l=c));var r=a.formatFont(d.lineFillFont,p,k),G=a.formatFont(d.lineStrokeFont,p,k);if(1==d.lineHashBackground||1==g.length)h=g[Math.floor(g.length/2)][0],1==g.length?this.drawBgText(b,n,p,h,d.backgroundAlpha,d.backgroundLineColor,d.backgroundLineWidth,d.backgroundColor,d.lineFillFont,d.lineBackgroundGap,d.lineHeight,d.lineBackgroundRadius,d.lineHashOutline,d.lineStrokeAlpha,d.lineStrokeStyle,d.lineLineWidth,d.lineStrokeFont,d.lineFillAlpha,d.lineFillStyle,m,q,e.id,!1,k):this.drawBgText(b,n,p,h,d.backgroundAlpha,d.backgroundLineColor,d.backgroundLineWidth,d.backgroundColor,d.lineFillFont,d.lineBackgroundGap,d.lineHeight,d.lineBackgroundRadius,d.lineHashOutline,d.lineStrokeAlpha,d.lineStrokeStyle,d.lineLineWidth,d.lineStrokeFont,d.lineFillAlpha,d.lineFillStyle,m,q,e.id,!0,k);else for(k=0;k<n.length;k++){var u=g[k],y=u[1],u=u[0],w=n.charAt(k);if(h){var x=w+"_"+u[0]+"_"+u[1]+"_"+y;if(null!=h.get(x))continue;h.set(x,!0);if(!l["in"]([u[0]/p,u[1]/p]))continue}1==d.lineHashOutline&&(b.save(),b.textAlign="center",b.textBaseline="middle",b.globalAlpha=d.lineStrokeAlpha,b.strokeStyle=d.lineStrokeStyle,b.lineWidth=d.lineLineWidth,b.font=G,b.translate(u[0]*p,u[1]*p),b.rotate(y*Math.PI/180),b.strokeText(w,0,0),b.restore());b.save();b.textAlign="center";b.textBaseline="middle";b.globalAlpha=d.lineFillAlpha;b.fillStyle=d.lineFillStyle;b.font=r;b.translate(u[0]*p,u[1]*p);b.rotate(y*Math.PI/180);b.fillText(w,0,0);b.restore();q&&(m.save(),this.setHitContextStyle(m,e.id),m.translate(u[0],u[1]),m.rotate(y*Math.PI/180),m.fillRect(.6*-d.lineHeight,.6*-d.lineHeight,1.2*d.lineHeight,1.2*d.lineHeight),m.restore())}};e.drawLineCode=function(a,b,e,c,f,m,g){c=b.style;var d=b.codePoint,h=b.label;1==c.showRoadCode&&h&&0<h.length&&this.drawBgText(a,h,e,d,c.codeBackgroundAlpha,c.codeBackgroundLineColor,c.codeBackgroundLineWidth,c.codeBackgroundColor,c.codeLineFillFont,c.codeLineBackgroundGap,c.codeLineHeight,c.codeLineBackgroundRadius,c.codeLineHashOutline,c.codeLineStrokeAlpha,c.codeLineStrokeStyle,c.codeLineLineWidth,c.codeLineStrokeFont,c.codeLineFillAlpha,c.codeLineFillStyle,m,g,b.id,!0,f)};e.drawLineArrow=function(a,b,e,c,f,m){c=b.arrowPoint;f=b.style;b=c[0][0];c=c[1][0];a.save();a.lineWidth=2;a.strokeStyle="#666666";a.fillStyle="#666666";a.beginPath();a.moveTo(b[0]*e,b[1]*e);a.lineTo(c[0]*e,c[1]*e);a.stroke();0==f.arrowDirectionValue?(f=Math.atan((c[1]-b[1])/(c[0]-b[0])),f+=(c[0]>b[0]?-90:90)*Math.PI/180,this.drawArrowhead(a,b[0],b[1],f,e)):(f=Math.atan((c[1]-b[1])/(c[0]-b[0])),f+=(c[0]>b[0]?90:-90)*Math.PI/180,this.drawArrowhead(a,c[0],c[1],f,e));a.restore()};e.drawArrowhead=function(a,b,e,c,f){a.beginPath();a.translate(b*f,e*f);a.rotate(c);a.moveTo(0,0);a.lineTo(3*f,6*f);a.lineTo(0,5);a.lineTo(-3*f,6*f);a.closePath();a.fill()};e.drawRoundRect=function(a,b,e,c,f,m,g){a.beginPath();a.arc((b+m)*g,(e+m)*g,m*g,Math.PI,3*Math.PI/2);a.lineTo((c-m+b)*g,e*g);a.arc((c-m+b)*g,(m+e)*g,m*g,3*Math.PI/2,2*Math.PI);a.lineTo((c+b)*g,(f+e-m)*g);a.arc((c-m+b)*g,(f-m+e)*g,m*g,0,1*Math.PI/2);a.lineTo((m+b)*g,(f+e)*g);a.arc((m+b)*g,(f-m+e)*g,m*g,1*Math.PI/2,Math.PI);a.closePath()};e.drawBgText=function(b,e,c,h,f,m,g,t,l,v,r,C,G,u,y,w,x,M,N,E,Q,V,R,D){b.save();b.globalAlpha=f;b.strokeStyle=m;b.lineWidth=g;b.fillStyle=t;b.font=a.formatFont(l,1,D);f=b.measureText(e).width;m=h[0]-f/2-v;g=h[1]-r/2-v;R&&(this.drawRoundRect(b,m,g,f+2*v,r+2*v,C,c),b.fill());b.restore();l=a.formatFont(l,c,D);x=a.formatFont(x,c,D);1==G&&(b.save(),b.textAlign="center",b.textBaseline="middle",b.globalAlpha=u,b.strokeStyle=y,b.lineWidth=w,b.font=x,b.translate(h[0]*c,h[1]*c),b.strokeText(e,0,0),b.restore());b.save();b.textAlign="center";b.textBaseline="middle";b.globalAlpha=M;b.fillStyle=N;b.font=l;b.translate(h[0]*c,h[1]*c);b.fillText(e,0,0);b.restore();Q&&(E.save(),this.setHitContextStyle(E,V),this.drawHitRoundRect(E,m,g,f+2*v,r+2*v,C),E.fill(),E.restore())};e.featureIdToHex=function(a){a="000000"+(Number(a)+1).toString(16);var b=a.length;return a="#"+a.substring(b-6,b)};e.setHitContextStyle=function(a,b){var d=this.featureIdToHex(b);a.globalAlpha=1;a.fillStyle=d};e.drawHitRoundRect=function(a,b,e,c,f,m){a.beginPath();a.arc(b+m,e+m,m,Math.PI,3*Math.PI/2);a.lineTo(c-m+b,e);a.arc(c-m+b,m+e,m,3*Math.PI/2,2*Math.PI);a.lineTo(c+b,f+e-m);a.arc(c-m+b,f-m+e,m,0,1*Math.PI/2);a.lineTo(m+b,f+e);a.arc(m+b,f-m+e,m,1*Math.PI/2,Math.PI);a.closePath()};return e}();l.exports=g},{"../../../utils/gistools/BoxSet":34,"../../../utils/gistools/GisTools":35,"./Util":19}],17:[function(g,l,r){function f(b,a,e){var d=this.cells=[];if(b instanceof ArrayBuffer){this.arrayBuffer=b;var f=new Int32Array(this.arrayBuffer);b=f[0];a=f[1];e=f[2];this.d=a+2*e;for(var p=0;p<this.d*this.d;p++){var h=f[c+p],k=f[c+p+1];d.push(h===k?null:f.subarray(h,k))}p=f[c+d.length+1];this.keys=f.subarray(f[c+d.length],p);this.bboxes=f.subarray(p);this.insert=this._insertReadonly}else{this.d=a+2*e;for(f=0;f<this.d*this.d;f++)d.push([]);this.keys=[];this.bboxes=[]}this.n=a;this.extent=b;this.padding=e;this.scale=a/b;this.uid=0;a=e/a*b;this.min=-a;this.max=b+a}l.exports=f;var c=3;f.prototype.insert=function(b,a,e,d,c){this._forEachCell(a,e,d,c,this._insertCell,this.uid++);this.keys.push(b);this.bboxes.push(a);this.bboxes.push(e);this.bboxes.push(d);this.bboxes.push(c)};f.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer.";};f.prototype._insertCell=function(b,a,e,d,c,f){this.cells[c].push(f)};f.prototype.query=function(b,a,e,d){var c=this.min,f=this.max;if(b<=c&&a<=c&&f<=e&&f<=d)return Array.prototype.slice.call(this.keys);c=[];this._forEachCell(b,a,e,d,this._queryCell,c,{});return c};f.prototype._queryCell=function(b,a,e,d,c,f,h){c=this.cells[c];if(null!==c)for(var k=this.keys,n=this.bboxes,g=0;g<c.length;g++){var p=c[g];if(void 0===h[p]){var l=4*p;b<=n[l+2]&&a<=n[l+3]&&e>=n[l+0]&&d>=n[l+1]?(h[p]=!0,f.push(k[p])):h[p]=!1}}};f.prototype._forEachCell=function(b,a,e,d,c,f,h){for(var k=this._convertToCellCoord(b),n=this._convertToCellCoord(a),g=this._convertToCellCoord(e),p=this._convertToCellCoord(d);k<=g;k++)for(var l=n;l<=p;l++)if(c.call(this,b,a,e,d,this.d*l+k,f,h))return};f.prototype._convertToCellCoord=function(b){return Math.max(0,Math.min(this.d-1,Math.floor(b*this.scale)+this.padding))};f.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var b=this.cells,a=c+this.cells.length+1+1,e=0,d=0;d<this.cells.length;d++)e+=this.cells[d].length;e=new Int32Array(a+e+this.keys.length+this.bboxes.length);e[0]=this.extent;e[1]=this.n;e[2]=this.padding;for(d=0;d<b.length;d++){var f=b[d];e[c+d]=a;e.set(f,a);a+=f.length}e[c+b.length]=a;e.set(this.keys,a);a+=this.keys.length;e[c+b.length+1]=a;e.set(this.bboxes,a);return e.buffer}},{}],18:[function(g,l,r){var f=g("./Util");g=function(){function c(b,a){_classCallCheck(this,c);this.boxDistance=0;this.ctx=b;this.formatFont=a}c.prototype.setBox=function(b,a){b.forEach(function(b,c){b.hidden=!1;b.label=f.formatLabel(b.label);0==b.style.show?b.hidden=!0:(1==b.type&&(a?this.setPointBox(b,b.sourceAngleData,this.ctx):this.setPointBox(b,b.datas,this.ctx)),2==b.type&&("text"==b.lineType&&(a?this.setTextLineBox(b,b.sourceAngleData,this.ctx):this.setTextLineBox(b,b.datas,this.ctx)),"code"==b.lineType&&(a?this.setCodeLineBox(b,b.sourceAngleData,this.ctx):this.setCodeLineBox(b,b.datas,this.ctx)),"arrow"==b.lineType&&(a?this.setArrowLineBox(b,b.sourceAngleData):this.setArrowLineBox(b,b.datas))))}.bind(this));return this.filterFeature(b)};c.prototype.setPointBox=function(b,a,c){var d=b.style,e,g,h=d.graphicWidth,k=d.graphicHeight;(e=b.iconImg)?h&&k||(h=e.width,k=e.height):k=h=0;e=h;g=k;if(d.labelFunction){var m=new Function("label",d.labelFunction);try{b.label=m.call({},b.attributes[d.labelfield])}catch(v){console.warn(b.label+": \u8c03\u7528labelFunction\u5931\u8d25!")}}if((m=f.isNotNull(b.label))||0!=h&&0!=k){if(m){b.label+="";g=b.label.split(" ");e=0;c.save();c.font=this.formatFont?f.formatFont(d.pointFillFont,1,!0):d.pointFillFont;for(m=0;m<g.length;m++){var q=c.measureText(g[m]).width;e=q>e?q:e}c.restore();g=d.pointHeight*g.length+2*(g.length-1);g=g>k?g:k}c=d.pointOffsetX;m=d.pointOffsetY;c||(c=0);m||(m=0);a=[a[0][0][0],a[0][0][1]];a[0]+=c;a[1]+=m;1!=d.pointHashBackground&&(d.pointBackgroundGap=0);if(0==k||0==h)d.graphicDistance=0;d.direction||(d.direction=0);c=k;d.pointHeight>k&&(c=d.pointHeight);if(b.style.texture)var m=[a[0]-.5*h,a[1]-d.pointBackgroundGap-.5*g,a[0]+.5*h+d.graphicDistance+e+2*d.pointBackgroundGap,a[1]+.5*g+d.pointBackgroundGap],q=[a[0]-.5*h-d.graphicDistance-e-2*d.pointBackgroundGap,m[1],a[0]+.5*h,m[3]],t=[a[0]-.5*e-d.pointBackgroundGap,a[1]-.5*k,a[0]+.5*e+d.pointBackgroundGap,a[1]+.5*k+d.graphicDistance+2*d.pointBackgroundGap+g],l=[t[0],a[1]-d.graphicDistance-2*d.pointBackgroundGap-g-.5*k,t[2],a[1]+.5*k],m=this.boxScale(m,d.pointBoxDisance),q=this.boxScale(q,d.pointBoxDisance),t=this.boxScale(t,d.pointBoxDisance),l=this.boxScale(l,d.pointBoxDisance),m=[m,q,t,l],q=[a[0]-.5*e,a[1]+d.graphicDistance+d.pointBackgroundGap+.5*c+.5*k],h=[[a[0]+.5*h+d.graphicDistance+d.pointBackgroundGap,a[1]-.5*g+.5*c],[a[0]-.5*h-d.graphicDistance-d.pointBackgroundGap-e,a[1]-.5*g+.5*c],q,[q[0],a[1]-d.graphicDistance-d.pointBackgroundGap-g+.5*c-.5*k]];else d.direction=0,h=[a[0]-.5*e-d.pointBackgroundGap,a[1]-d.pointBackgroundGap-.5*g,a[0]+.5*e+d.pointBackgroundGap,a[1]+d.pointBackgroundGap+.5*g],h=this.boxScale(h,d.pointBoxDisance),m=[h],h=[[a[0]-.5*e,a[1]-.5*g+.5*c]];b.boxs=m;b.box=m[d.direction];b.fourPoints=h;b.style.textPoint=h[d.direction]}else b.hidden=!0};c.prototype.setTextLineBox=function(b,a,c){var d=b.label;if(0==a.length)b.hidden=!0;else{var e=b.style;b.textPoints=a;var g=[];if(1==e.lineHashBackground||1==a.length){var h=a[0][0];1<a.length&&(h=a[Math.floor(d.length/2)][0]);c.save();c.font=this.formatFont?f.formatFont(e.lineFillFont,1,!0):e.lineFillFont;a=c.measureText(b.label).width;c.restore();a=[h[0]-a/2-e.lineBackgroundGap,h[1]-.5*e.lineHeight-e.lineBackgroundGap,h[0]+a/2+e.lineBackgroundGap,h[1]+.5*e.lineHeight+e.lineBackgroundGap];this.boxScale(a,e.lineTextBoxDisance);g.push(a)}else{if(e.lineTextRotate||0==e.lineTextRotate)for(c=0;c<a.length;c++)a[c][1]=e.lineTextRotate;else if(this.textToSameBearing(b.angle,a),!e.isImportant&&this.isMessy(a,e,d)){b.hidden=!0;return}if(e=this.getLineBoxs(d,a,e))g=g.concat(e);else{b.hidden=!0;return}}b.boxs=g}};c.prototype.setCodeLineBox=function(b,a,c){if(0==a.length)b.hidden=!0;else{var d=b.style;a=a[0][0];c.save();c.font=this.formatFont?f.formatFont(d.codeLineFillFont,1,!0):d.codeLineFillFont;var e=c.measureText(b.label).width;c.restore();c=[a[0]-e/2-d.codeLineBackgroundGap,a[1]-.5*d.codeLineHeight-d.codeLineBackgroundGap,a[0]+e/2+d.codeLineBackgroundGap,a[1]+.5*d.codeLineHeight+d.codeLineBackgroundGap];this.boxScale(c,d.lineCodeBoxDisance);b.boxs=[c];b.codePoint=a}};c.prototype.setArrowLineBox=function(b,a){if(2!=a.length)b.hiden=!0;else{var c=a[0][0],d=a[1][0],c=[c[0]<d[0]?c[0]:d[0],c[1]<d[1]?c[1]:d[1],c[0]>d[0]?c[0]:d[0],c[1]>d[1]?c[1]:d[1]];this.boxScale(c,b.style.lineArrowBoxDisance);b.boxs=[c];b.arrowPoint=a}};c.prototype.filterFeature=function(b){for(var a=[],c=0;c<b.length;c++)b[c].hidden||a.push(b[c]);return a};c.prototype.isMessy=function(b,a,c){for(var d=b[0][0],e=d[0],f=d[1],h=d[0],d=d[1],k=b[0][1],g=b[0][1],q=0;q<c.length;q++){var t=b[q][0],l=b[q][1];t[0]>h&&(h=t[0]);t[0]<e&&(e=t[0]);t[1]>d&&(d=t[1]);t[1]<f&&(f=t[1]);l>g&&(g=l);l<k&&(k=l)}if(g-k>a.angle)if(0==a.angleSwitch&&a.angleColor)a.lineFillStyle=a.angleColor;else return!0;return!1};c.prototype.getLineBoxs=function(b,a,c){for(var d=[],e=[],f=0;f<b.length;f++){var h=a[f][0];0==a[f][1]&&(a[f][1]=.5);var k=[h[0]-.6*c.lineHeight,h[1]-.6*c.lineHeight,h[0]+.6*c.lineHeight,h[1]+.6*c.lineHeight];this.boxScale(k,c.lineTextBoxDisance);e.push([h[0]-.5*c.lineHeight,h[1]-.6*c.lineHeight,h[0]+.5*c.lineHeight,h[1]+.5*c.lineHeight]);d.push(k)}if(!c.isImportant)for(b=0;b<e.length-1;b++)for(a=e[b],c=b+1;c<e.length;c++)if(this.crashBox(a,e[c]))return null;return d};c.prototype.crashBox=function(b,a){return b[0]<=a[2]&&b[2]>=a[0]&&b[1]<=a[3]&&b[3]>=a[1]};c.prototype.boxScale=function(b,a){a||0==a||(a=this.boxDistance);b[0]-=.5*a;b[1]-=.5*a;b[2]+=.5*a;b[3]+=.5*a;return b};c.prototype.textToSameBearing=function(b,a){45<=b?b-=90:-45>=b&&(b+=90);for(var c=0;c<a.length;c++){var d=a[c][1],f=b-d;45<f&&(a[c][1]=d+90);-45>f&&(a[c][1]=d-90)}};return c}();l.exports=g},{"./Util":19}],19:[function(g,l,r){g=function(){function f(){_classCallCheck(this,f)}f.getRealLength=function(c){for(var b=c.length,a=0,e=0;e<b;e++)var d=c.charCodeAt(e),a=0<=d&&128>=d?a+.5:a+1;return a};f.isNotNull=function(c){return!c&&0!=c||"string"==typeof c&&(c=c.toLowerCase(),""==c||"undefined"==c||"null"==c)?!1:!0};f.formatFont=function(c,b,a){var e=c;a&&(c=c.split(" "),c[c.length-1]="SimHei",e=c.join(" "));return e.replace(/(\d+\.?\d*)(px|em|rem|pt)/g,function(a,c,e){c=12>c?12*b:Math.round(c)*b;return c+e})};f.formatLabel=function(c){c&&0<c.length&&(c=c.replace(/([\x00-\x1f\x7f])/g,""),c=c.replace(/(\s*$)/g,""),c=c.replace(/<br\/>/g,""));return c};f.getAngle=function(c,b){return 0==b[0]-c[0]?b[1]>c[0]?90:-90:360*Math.atan((b[1]-c[1])/(b[0]-c[0]))/(2*Math.PI)};return f}();l.exports=g},{}],20:[function(g,l,r){var f=g("../../../utils/Cache"),c=g("../avoid/GDrawGeomerty");r=g("./../../../utils/es6-promise");var b=r.Promise,a=r.getParamJSON,e=g("./LabelDrawer"),d=g("./../avoid/GAnnoAvoid"),n=g("./../avoid/GCutLine");g=function(){function g(){_classCallCheck(this,g);this.height=this.width=0;this.grid=[];this.cache=new f(256);this.gwvtAnno=null;this.dataSource=[];this.isReady=!1;this.maxExtent=[];this.extent=[];this.res=0;this.tileSize=256;this.hitDetection=!1;this.features=[];this.requestingTiles={};this.hasImportant=!0;this.ratio=1;var a=document.createElement("CANVAS").getContext("2d",{isQuality:!0});this.GAnnoAvoid=new d(a,!1)}g.prototype.init=function(a,b,c,d){this.tileSize=c;this.gwvtAnno=d;this.initCanvas(a,b);this.loadResources()};g.prototype.loadResources=function(){if(0==this.dataSource.length)this.isReady=!1;else{this.cache.clean();for(var a=[],c=0;c<this.dataSource.length;c++){var d=this.dataSource[c];"URLDataSource"==d.type&&(a=a.concat(d.loadStyle()));"LocalDataSource"==d.type&&(a=a.concat(d.loadTexture()))}0<a.length?b.all(a).then(function(){this.isReady=!0;0<this.grid.length&&this.requestLabelTiles(this.grid)}.bind(this)):this.isReady=!0}};g.prototype.initCanvas=function(a,b){this.width=a;this.height=b;this.root||(this.root=document.createElement("canvas"));this.root.style.width=this.width+"px";this.root.style.height=this.height+"px";this.root.width=this.width*this.ratio;this.root.height=this.height*this.ratio;this.root.id="labelCanvas";this.canvas=this.root.getContext("2d",{isQuality:!0});this.hitDetection&&(this.hitCanvas||(this.hitCanvas=document.createElement("canvas")),this.hitCanvas.style.width=this.width+"px",this.hitCanvas.style.height=this.height+"px",this.hitCanvas.width=this.width,this.hitCanvas.height=this.height,this.hitContext=this.hitCanvas.getContext("2d",{isQuality:!0}))};g.prototype.addDataSource=function(a){"URLDataSource"==a.type&&(a.url=a.url+"\x26tilesize\x3d"+this.tileSize);"URLDataSource"!=a.type&&"LocalDataSource"!=a.type||this.dataSource.push(a)};g.prototype.removeDataSourceById=function(a){for(var b=0;b<this.dataSource.length;b++)if(this.dataSource[b].id==a){this.dataSource.splice(b,1);break}};g.prototype.getDataSourceById=function(a){for(var b=0;b<this.dataSource.length;b++)if(this.dataSource[b].id==a)return this.dataSource[b]};g.prototype.clean=function(){this.canvas.clearRect(0,0,this.width*this.ratio,this.height*this.ratio);this.hitContext&&this.hitContext.clearRect(0,0,this.width,this.height)};g.prototype.redraw=function(){0!=this.grid.length&&(this.cache.clean(),this.loadResources())};g.prototype.requestLabelTiles=function(a,b){this.grid=a;if(this.isReady){var c=this.getRequestTileUrls(a);this.sendRequest(c)}};g.prototype.getLocalLabelDatas=function(){for(var a=[],b=0;b<this.dataSource.length;b++){var c=this.dataSource[b];if("LocalDataSource"==c.type)for(var d=0;d<c.features.length;d++){var e=c.features[d];e.inBounds(this.extent)&&(1==e.type&&(e.sourceAngleData=[[e.sourceData,0]],e.transformData(this.extent,this.res),e.label=e.getFeatureLabel(),e.textures=c.textures,a.push(e)),2==e.type&&(e.label=e.getFeatureLabel(),e.textures=c.textures,a=a.concat(this.cutLineFeature(e,!0))))}}return a};g.prototype.getRequestTileUrls=function(a){this.hitCacheUrls=[];this.currentTileDatas=[];for(var b={},c={},d=0;d<this.dataSource.length;d++){var e=this.dataSource[d];if("URLDataSource"==e.type)for(var f=e.url,h=0;h<a.length;h++){var g=a[h],n=f.replace("${x}",g.col).replace("{x}",g.col),n=n.replace("${y}",g.row).replace("{y}",g.row),n=n.replace("${z}",g.level).replace("{z}",g.level);if(0<e.urlArray.length)var p=e.urlArray[Math.round(Math.random()*(e.urlArray.length-1))],n=n.split("/mapserver")[1],n=p+"/mapserver"+n;this.cache.getItem(n)?this.hitCacheUrls.push(n):this.requestingTiles[n]?c[n]=!0:b[n]={url:n,xyz:g,dataSourceId:e.id,dataType:"json"}}}this.cancelRequest(c);return b};g.prototype.cancelRequest=function(a){for(var b in this.requestingTiles)if(!a[b]){var c=this.requestingTiles[b];delete this.requestingTiles[b];c.xhr.abort();c.requestItem.cancel=!0}};g.prototype.sendRequest=function(b){var c=0,d;for(d in b){var e=b[d],f=a(e);this.requestingTiles[e.url]={xhr:f.xhr,requestItem:e};f.then(this.tileSuccessFunction.bind(this),this.tileFailFunction.bind(this));c++}0==c&&this.sendSuccess([])};g.prototype.tileSuccessFunction=function(a){if(1!=a.param.cancel){var b=a.param.url;delete this.requestingTiles[b];a=this.parseFeature(a);var c=this.GAnnoAvoid.GLabelBox.setBox(a.labelFeatures,!0),c=this.GAnnoAvoid.avoid(c,a.avoidLineFeatures);this.currentTileDatas.push({url:b,labelFeatures:c,avoidLineFeatures:a.avoidLineFeatures});this.isEmptyObject(this.requestingTiles)&&this.sendSuccess(this.currentTileDatas)}};g.prototype.isEmptyObject=function(a){for(var b in a)return!1;return!0};g.prototype.tileFailFunction=function(a){1!=a.param.cancel&&(delete this.requestingTiles[a.param.url],this.isEmptyObject(this.requestingTiles)&&this.sendSuccess(this.currentTileDatas))};g.prototype.sendSuccess=function(a){if(!this.gwvtAnno.animating){for(var b=this.mergeLabelData(a,this.hitCacheUrls).labelFeatures,d=0;d<a.length;d++){var e=a[d];this.cache.push(e.url,e)}a=this.getLocalLabelDatas();b=b.concat(a);this.avoidlabelDatas=this.GAnnoAvoid.defaultAvoid(b,this.hasImportant);this.gwvtAnno.resetCanvasDiv();this.clean();if(this.hitDetection)for(this.features=[],b=0;b<this.avoidlabelDatas.length;b++)a=this.avoidlabelDatas[b],this.features[a.id]=a;c.draw(this.canvas,this.avoidlabelDatas,this.ratio,!1,!1,this.hitContext,this.hitDetection)}};g.prototype.drawAvoidLine=function(a){this.canvas.save();this.canvas.beginPath();for(var b=0;b<a.length;b++){var c=a[b];this.canvas.lineWidth=1;this.canvas.strokeStyle="#fff000";this.canvas.moveTo(c.datas[0],c.datas[1]);for(j=1;j<c.datas.length/2;j++)this.canvas.lineTo(c.datas[2*j],c.datas[2*j+1])}this.canvas.stroke();this.canvas.restore()};g.prototype.parseFeature=function(a){var b=a.data,c=a.param.xyz,d=0,f;for(f in b)b[f].xyz=c,d++;f=[];var g=this.getDataSourceById(a.param.dataSourceId);if(0<d&&g&&g.styleFun){d=[];a=a.param.xyz.level;var h=new e(b,a,d);g.styleFun.call({},h,a);for(a=0;a<d.length;a++)h=d[a],h.textures=g.textures,f=f.concat(this.parseItemData(h))}b=this.parseAvoidLine(b._layerAvoids,c);return{labelFeatures:f,avoidLineFeatures:b}};g.prototype.parseAvoidLine=function(a,b){var c=[],d;for(d in a){var e=a[d];d=parseInt(d);for(var f=0;f<e.length;f++){var g={};g.weight=d;g.sourceDatas=e[f];g.datas=this.transformAvoidLine(e[f],b);g.xyz=b;c.push(g)}}return c};g.prototype.transformAvoidLine=function(a,b){for(var c=(this.extent[0]-this.maxExtent[0])/this.res,d=(this.maxExtent[3]-this.extent[3])/this.res,e=[],f=0;f<a.length/2;f++){var g=a[2*f+1]+b.row*this.tileSize;e.push(a[2*f]+b.col*this.tileSize-c);e.push(g-d)}return e};g.prototype.parseItemData=function(a){var b=[];1==a.type&&(b=this.parsePoint(a));2==a.type&&("LINESTRING"==a[0]&&(b=b.concat(this.parseLine(a))),"MULTILINESTRING"==a[0]&&(b=b.concat(this.parseMultiLine(a,a[2][0][0]))));return b};g.prototype.parsePoint=function(a){var b=[],c=a[2],d=[[c,0]],e=this.transformData(d,a.xyz),f=a.style,g=a.fieldValueMap[f.labelfield],h=a.fieldValueMap.attributeId+"_row_"+a.xyz.row+"_col_"+a.xyz.col+"_level_"+a.xyz.level+"_x_"+d[0][0][0]+"_y_"+d[0][0][1],n=0;a.fieldValueMap[f.avoidField]&&(n=parseInt(a.fieldValueMap[f.avoidField]),isNaN(n)&&(n=0));var p={0:1};f.texture&&(p={0:1,1:1,2:1,3:1});b.push({id:Math.round(16777216*Math.random()),type:a.type,datas:e,sourceData:c,sourceAngleData:d,label:g,attributeId:a.fieldValueMap.attributeId,primaryId:h,style:f,iconImg:a.textures[f.texture],xyz:a.xyz,weight:n,directions:p,attributes:a.fieldValueMap});return b};g.prototype.parseLine=function(a){return 0==a[2].length?[]:Array.isArray(a[2][0][0])?this.parseMultiLine(a,a[2][0]):this.parseMultiLine(a,a[2])};g.prototype.parseMultiLine=function(a,b){for(var c=[],d=a.style,e=0;e<b.length;e++){var f=b[e];if(0!=f.length){var g=a.fieldValueMap[d.labelfield],h=a.fieldValueMap[d.roadCodeLabel],n=0;a.fieldValueMap[d.avoidField]&&(n=parseInt(a.fieldValueMap[d.avoidField]));f={type:a.type,sourceData:f,label:g,weight:n,roadCodeLabel:h,attributeId:a.fieldValueMap.attributeId,style:this.cloneStyle(d),textures:a.textures,xyz:a.xyz,attributes:a.fieldValueMap};c=c.concat(this.cutLineFeature(f,!1))}}return c};g.prototype.cloneStyle=function(a){var b={},c;for(c in a)b[c]=a[c];return b};g.prototype.cutLineFeature=function(a,b){for(var c=n.cutLineFeature(a),d=0;d<c.length;d++){var e=c[d];e.datas=b?a.transformData(this.extent,this.res):this.transformData(e.sourceAngleData,e.xyz);e.primaryId=e.attributeId+"_row_"+a.xyz.row+"_col_"+a.xyz.col+"_level_"+a.xyz.level+"_x_"+e.sourceAngleData[0][0][0]+"_y_"+e.sourceAngleData[0][0][1];e.id=Math.round(16777216*Math.random());"text"==e.lineType&&(e.centerPoint=e.datas[Math.floor(e.datas.length/2)][0]);"code"==e.lineType&&(e.centerPoint=e.datas[0][0])}return c};g.prototype.transformData=function(a,b){for(var c=(this.extent[0]-this.maxExtent[0])/this.res,d=(this.maxExtent[3]-this.extent[3])/this.res,e=[],f=0;f<a.length;f++){var g=a[f][0];e.push([[g[0]+b.col*this.tileSize-c,g[1]+b.row*this.tileSize-d],a[f][1]])}return e};g.prototype.mergeLabelData=function(a,b){for(var c=[],d=[],e=0;e<a.length;e++)var f=a[e],c=c.concat(f.labelFeatures),d=d.concat(f.avoidLineFeatures);for(e=0;e<b.length;e++){for(var f=this.cache.getItem(b[e]).labelFeatures,g=0;g<f.length;g++){var h=f[g];h.datas=this.transformData(h.sourceAngleData,h.xyz);"text"==h.lineType&&(h.centerPoint=h.datas[Math.floor(h.datas.length/2)][0]);"code"==h.lineType&&(h.centerPoint=h.datas[0][0])}c=c.concat(f);f=this.cache.getItem(b[e]).avoidLineFeatures;for(g=0;g<f.length;g++)h=f[g],h.datas=this.transformAvoidLine(h.sourceDatas,h.xyz);d=d.concat(f)}return{labelFeatures:c,avoidLineFeatures:d}};g.prototype.getFeatureByXY=function(a,b){var c=null;if(this.hitDetection){var d=this.hitContext.getImageData(a,b,1,1).data;if(255===d[3]&&(d=d[2]+256*(d[1]+256*d[0])))try{c=this.features[d-1]}catch(t){}}return c};return g}();l.exports=g},{"../../../utils/Cache":31,"../avoid/GDrawGeomerty":16,"./../../../utils/es6-promise":33,"./../avoid/GAnnoAvoid":13,"./../avoid/GCutLine":14,"./LabelDrawer":21}],21:[function(g,l,r){g=function(){function f(c,b,a){_classCallCheck(this,f);this.layerDataMap=c;this.level=b;this.features=a}f.prototype.getLayer=function(c){this.labelDatas=[];var b=this.layerDataMap[c];if(null==b||null==b.features)return this;for(var a=0;a<b.features.length;a++){var e=b.features[a];e.layerName=c;e.xyz=b.xyz;e.type=b.type;e.fieldValueMap||(e.fieldValueMap=this.getFieldValueMap(b,e));this.labelDatas.push(e)}return this};f.prototype.getGroupLayer=function(c,b){this.labelDatas=[];var a=b.split(","),e=a.length;if(0==e)return this;var d=this.layerDataMap[c];if(null==d||null==d.features)return this;for(var f=0;f<e;f++)if(null!=d.features[a[f]]){var g=d.features[i];g.layerName=c;g.xyz=d.xyz;g.type=d.type;g.fieldValueMap||(g.fieldValueMap=this.getFieldValueMap(d,g));this.labelDatas.push(g)}return this};f.prototype.setStyle=function(c){for(var b=this,a=function(a){var d=b.labelDatas[a];(a=c.call({},b.level,function(a){return d.fieldValueMap[a]}))&&1==a.show&&(d.style=a,d.fieldValueMap.avoidWeight=a.avoidWeight,b.features.push(d))},e=0;e<this.labelDatas.length;e++)a(e)};f.prototype.getFieldValueMap=function(c,b){for(var a={},e=0;e<c.fieldsConfig.length;e++){var d=c.fieldsConfig[e].name,f=c.fieldsConfig[e].index;1==c.fieldsConfig[e].id&&(a.attributeId=b.layerName+b[1][f]);a[d]=b[1][f]}return a};f.prototype.draw=function(){};return f}();l.exports=g},{}],22:[function(g,l,r){g=function(){function f(){_classCallCheck(this,f);this.id=Math.round(16777216*Math.random());this.type=1;this.sourceData=[];this.datas=[];this.sourceAngleData=[];this.attributes={};this.style={}}f.prototype.addAttribute=function(c,b){this.attributes[c]=b};f.prototype.removeAttributeByKey=function(c){delete this.attributes[c]};f.prototype.getMaxExtent=function(){if(0==this.sourceData.length)return null;for(var c=this.sourceData[0],b=this.sourceData[0],a=this.sourceData[1],e=this.sourceData[1],d=2;d<this.sourceData.length;d++){var f=this.sourceData[d],g=this.sourceData[d+1];f>b&&(b=f);f<c&&(c=f);g>e&&(e=g);g<a&&(a=g);d++}return[c,a,b,e]};f.prototype.inBounds=function(c){var b=this.getMaxExtent();return b?b[0]<=c[2]&&b[2]>=c[0]&&b[1]<=c[3]&&b[3]>=c[1]:!1};f.prototype.transformData=function(c,b){this.datas=[];if(0!=this.sourceData.length){for(var a=c[0],e=c[3],d=[],f=0;f<this.sourceAngleData.length;f++){var g=this.sourceAngleData[f][0];d.push([[(g[0]-a)/b,(e-g[1])/b],this.sourceAngleData[f][1]])}this.datas=d}};f.prototype.getFeatureLabel=function(){var c=this.style.labelfield;return c&&this.attributes[c]?this.attributes[c]+"":null};return f}();l.exports=g},{}],23:[function(g,l,r){r=g("./GVMapGrid");g("./draw/GVMapGridUtil");g=r.extend({styleObj:{},styleJs:null,initialize:function(f,c){c.isDynamicMap=!0;1.5<window.devicePixelRatio&&(this.ratio=2);this.sourceUrl||(this.sourceUrl=f);c&&c.tileSize&&(this.tilesize=c.tileSize);this.gVMapGridUtil=new Custom.GVMapGridUtil(c.isDynamicMap);this.gVMapGridUtil.tileSize=this.tilesize;this.gVMapGridUtil.parseUrl(f);this._url=f+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version;L.setOptions(this,c);this.hitDetection=c.hitDetection;this.on("tileunload",this._onTileRemove);this.on("tileload",this._onTileLoad);this.on("tileerror",this._onTileError)},onAdd:function(){this.control&&(this._url=this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version+"\x26control\x3d"+this.control);this.controlId&&(this._url=this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version+"\x26controlId\x3d"+this.controlId);this._initContainer();this._levels={};this._tiles={};this.gVMapGridUtil.setStyle(this.styleObj);var f=this.gVMapGridUtil.loadStyle("layer");Promise.all(f).then(function(){this._resetView();this._update()}.bind(this))},addLevels:function(f){this.styleObj[f.levelsKey]=f.levelsData},redraw:function(){this.gVMapGridUtil.formatStyle(this.styleObj,function(){this._map&&(this._removeAllTiles(),this._update())});return this}});l.exports=g},{"./GVMapGrid":24,"./draw/GVMapGridUtil":26}],24:[function(g,l,r){g=L.TileLayer.extend({urlArray:[],sourceUrl:null,textures:{},tileQueue:[],ratio:1,control:null,controlId:null,tilesize:256,initialize:function(f,c){1.5<window.devicePixelRatio&&(this.ratio=2);this.sourceUrl||(this.sourceUrl=f);c&&c.tileSize&&(this.tilesize=c.tileSize);this.gVMapGridUtil=new Custom.GVMapGridUtil;this.gVMapGridUtil.tileSize=this.tilesize;this.gVMapGridUtil.parseUrl(f);this._url=f+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version;L.setOptions(this,c);this.hitDetection=c.hitDetection;this.on("tileunload",this._onTileRemove);this.on("tileload",this._onTileLoad);this.on("tileerror",this._onTileError)},onAdd:function(){this.control&&(this._url=this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version+"\x26control\x3d"+this.control);this.controlId&&(this._url=this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version+"\x26controlId\x3d"+this.controlId);this._initContainer();this._levels={};this._tiles={};var f=this.gVMapGridUtil.loadStyle("layer");Promise.all(f).then(function(){this._resetView();this._update()}.bind(this))},createTile:function(f,c){var b=this.tileQueue.pop();b?this._cleanTile(b):b=this.initTile();var a=this.getTileUrl(f);Custom.getJSON({url:a,dataType:"json"}).then(function(a){b.data=a;this._tileOnLoad.apply(this,[c,b])}.bind(this),function(a){this._tileOnError.apply(this,[c,b,a])}.bind(this));return b},getTileUrl:function(f){var c={r:L.Browser.retina?"@2x":"",s:this._getSubdomain(f),x:f.x,y:f.y,z:this._getZoomForUrl()};this._map&&!this._map.options.crs.infinite&&(f=this._globalTileRange.max.y-f.y,this.options.tms&&(c.y=f),c["-y"]=f);if(0==this.urlArray.length)return L.Util.template(this._url,L.extend(c,this.options));f=this.urlArray[Math.round(Math.random()*(this.urlArray.length-1))];var b=this._url.split("/mapserver")[1];return L.Util.template(f+"/mapserver"+b,L.extend(c,this.options))},initTile:function(){var f=document.createElement("canvas");f.style.width=this.tilesize+"px";f.style.height=this.tilesize+"px";f.width=this.tilesize;f.height=this.tilesize;var c=f.getContext("2d",{isQuality:!0});f.ctx=c;return f},_onTileRemove:function(f){this.tileQueue.push(f.tile)},_abortLoading:function(){var f,c;for(f in this._tiles)this._tiles[f].coords.z!==this._tileZoom&&(c=this._tiles[f].el,c.complete||L.DomUtil.remove(c))},_onTileLoad:function(f){f=f.tile;this._drawTile(f,f.data);f.complete=!0},_onTileError:function(f){f=f.tile;f.complete=!0;this.tileQueue.push(f)},_tileOnError:function(f,c,b){f(b,c)},_drawTile:function(f,c){var b=f.ctx,a=Math.floor(this._map.getZoom()),b=new DataHolder({layerDataMap:c,ctx:b,ratio:1,control:null,textures:this.gVMapGridUtil.textures,extent:{level:a}});this.gVMapGridUtil.styleFun.call({},b,a)},_cleanTile:function(f){f.ctx.clearRect(0,0,this.tilesize,this.tilesize)},setFilter:function(f){this._url&&f&&(0!=f.layers.length||0!=f.order.length)&&this.gVMapGridUtil.setFilter(f,function(c){c.isIE?(this.controlId=c.id,this.setUrl(this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version+"\x26controlId\x3d"+c.id)):(this.control=c.id,this.setUrl(this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+Custom.Version+"\x26control\x3d"+c.id))}.bind(this))},getFeatureByXY:function(f,c,b){f=this._map.containerPointToLatLng(new L.point(f,c));this.getFeatureByLonlat(f,b)},getFeatureByLonlat:function(f,c){var b=this._map.options.crs.projection.bounds,a=this._map.getBounds(),e=this._map.getPixelBounds(),d=(a._northEast.lat-a._southWest.lat)/(e.max.y-e.min.y),a=this.options.tileSize,e=(b.max.y-f.lat)/(d*a),b=(f.lng-b.min.x)/(d*a),d=this._map.getZoom();this.gVMapGridUtil.pickupFeatures(e,b,d,(b-Math.floor(b))*a,(e-Math.floor(e))*a,this.control,this.controlId,function(a){c(a)})},highlightFeatures:function(f,c){var b=this.gVMapGridUtil.CreateHighlightFilter(f,c);if(0!=b.layers.length){c.color=c.color.replace("#","%23");if(!this.highlightLayer){var a=this.gVMapGridUtil.host+"/mapserver/vmap/"+this.gVMapGridUtil.servername+"/getMAP?x\x3d{x}\x26y\x3d{y}\x26l\x3d{z}\x26styleId\x3d"+this.gVMapGridUtil.styleId;this.control&&(a=a+"\x26control\x3d"+this.control);this.controlId&&(a=a+"\x26controlId\x3d"+this.controlId);this.highlightLayer=new L.GXYZ(a,this.options);this._map.addLayer(this.highlightLayer)}this.highlightLayer.options.opacity=c.opacity;this.highlightLayer._updateOpacity();this.highlightLayer.setFilter(b);this.highlightLayer.setZIndex(this.options.zIndex+1)}},cancelHighlight:function(){this.highlightLayer&&(this._map.removeLayer(this.highlightLayer),this.highlightLayer=null)}});l.exports=g},{}],25:[function(g,l,r){var f=g("./draw/GXYZUtil"),c=g("../../ext/Version");g=L.TileLayer.extend({urlArray:[],sourceUrl:null,gxyzUtil:null,highlightLayer:null,ratio:1,control:null,controlId:null,tilesize:256,initialize:function(b,a){1.5<window.devicePixelRatio&&(this.ratio=2);this.sourceUrl||(this.sourceUrl=b);a&&a.tileSize&&(this.tilesize=a.tileSize);this.gxyzUtil=new f;this.gxyzUtil.tileSize=this.tilesize;this.gxyzUtil.parseUrl(b);this._url=b+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c;L.setOptions(this,a)},onAdd:function(){this.control&&(this._url=this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26control\x3d"+this.control);this.controlId&&(this._url=this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26controlId\x3d"+this.controlId);this._initContainer();this._levels={};this._tiles={};this._resetView();this._update()},getTileUrl:function(b){var a={r:L.Browser.retina?"@2x":"",s:this._getSubdomain(b),x:b.x,y:b.y,z:this._getZoomForUrl()};this._map&&!this._map.options.crs.infinite&&(b=this._globalTileRange.max.y-b.y,this.options.tms&&(a.y=b),a["-y"]=b);if(0==this.urlArray.length)return L.Util.template(this._url,L.extend(a,this.options));b=this.urlArray[Math.round(Math.random()*(this.urlArray.length-1))];var c=this._url.split("/mapserver")[1];return L.Util.template(b+"/mapserver"+c,L.extend(a,this.options))},setFilter:function(b){this._url&&b&&(0!=b.layers.length||0!=b.order.length)&&this.gxyzUtil.setFilter(b,function(a){a.isIE?(this.controlId=a.id,this.setUrl(this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26controlId\x3d"+a.id)):(this.control=a.id,this.setUrl(this.sourceUrl+"\x26ratio\x3d"+this.ratio+"\x26tilesize\x3d"+this.tilesize+"\x26clientVersion\x3d"+c+"\x26control\x3d"+a.id))}.bind(this))},getFeatureByXY:function(b,a,c){b=this._map.containerPointToLatLng(new L.point(b,a));this.getFeatureByLonlat(b,c)},getFeatureByLonlat:function(b,a){var c=this._map.options.crs.projection.bounds,d=this._map.getBounds(),f=this._map.getPixelBounds(),g=(d._northEast.lat-d._southWest.lat)/(f.max.y-f.min.y),d=this.options.tileSize,f=(c.max.y-b.lat)/(g*d),c=(b.lng-c.min.x)/(g*d),g=this._map.getZoom();this.gxyzUtil.pickupFeatures(f,c,g,(c-Math.floor(c))*d,(f-Math.floor(f))*d,this.control,this.controlId,function(b){a(b)})},highlightFeatures:function(b,a){var c=this.gxyzUtil.CreateHighlightFilter(b,a);0!=c.layers.length&&(a.color=a.color.replace("#","%23"),this.highlightLayer||(this.highlightLayer=new L.GXYZ(this.sourceUrl,this.options),this._map.addLayer(this.highlightLayer)),this.highlightLayer.options.opacity=a.opacity,this.highlightLayer._updateOpacity(),this.highlightLayer.setFilter(c),this.highlightLayer.setZIndex(this.options.zIndex+1))},highlightEveryFeatures:function(b,a){var c=this.gxyzUtil.CreateEveryHighlightFilter(b);0!=c.layers.length&&(this.highlightLayer||(this.highlightLayer=new L.GXYZ(this.sourceUrl,this.options),this._map.addLayer(this.highlightLayer)),this.highlightLayer.options.opacity=a,this.highlightLayer._updateOpacity(),this.highlightLayer.setFilter(c),this.highlightLayer.setZIndex(this.options.zIndex+1))},cancelHighlight:function(){this.highlightLayer&&(this._map.removeLayer(this.highlightLayer),this.highlightLayer=null)}});l.exports=g},{"../../ext/Version":3,"./draw/GXYZUtil":27}],26:[function(g,l,r){r=g("./GXYZUtil");g=g("./../../../utils/es6-promise");var f=g.Deferred,c=g.getJSON;g=function(b){function a(c){_classCallCheck(this,a);var d=_possibleConstructorReturn(this,b.call(this));d.textures={};d.isDynamicMap=c;d.styleObj={};return d}_inherits(a,b);a.prototype.setStyle=function(a){this.styleObj=a};a.prototype.formatStyle=function(a,b){this.styleObj=a;var d=JSON.stringify(this.styleObj);c({type:"post",url:this.host+"/mapserver/styleInfo/format.do",data:"styleJson\x3d "+d,dataType:"json"}).then(function(a){this.styleFun=new Function("drawer","level",a.styleJs);b()}.bind(this))};a.prototype.loadStyle=function(a){var b=new f,e=new f;a||(a="label");this.isDynamicMap?(a=JSON.stringify(this.styleObj),c({type:"post",url:"http://127.0.0.1/mapserver/styleInfo/format.do",data:"styleJson\x3d "+a,dataType:"json"}).then(function(a){this.styleFun=new Function("drawer","level",a.styleJs);b.resolve()}.bind(this))):c({url:this.host+"/mapserver/styleInfo/"+this.servername+"/"+this.styleId+"/"+a+"/style.js",dataType:"text"}).then(function(a){this.styleFun=new Function("drawer","level",a);b.resolve()}.bind(this));c({url:this.host+"/mapserver/styleInfo/"+this.servername+"/"+this.styleId+"/label/texture.js",dataType:"text"}).then(function(a){a=JSON.parse(a);var b=0,c;for(c in a)b++;if(0==b)e.resolve();else{var d=0,f;for(f in a)c=new Image,c.name=f,c.onload=function(a){d++;this.textures[a.target.name]=a.target;d==b&&e.resolve()}.bind(this),c.src=a[f]}}.bind(this));return[b,e]};return a}(r);l.exports=g},{"./../../../utils/es6-promise":33,"./GXYZUtil":27}],27:[function(g,l,r){var f=g("./../../../utils/es6-promise").getJSON,c=g("./../../../filter/Filter"),b=g("./../../../filter/FilterLayer"),a=g("../../../ext/Version");g=function(){function e(){_classCallCheck(this,e);this.tileSize=256}e.prototype.setFilter=function(a,b){for(var c=0;c<a.layers.length;c++)a.layers[c].id||a.layers.splice(c,1);c=JSON.stringify(a);this.isIE()?f({type:"post",url:this.host+"/mapserver/vmap/"+this.servername+"/setControl",data:"control\x3d "+c,dataType:"json"}).then(function(a){a.isIE=!0;b(a)}.bind(this)):b({isIE:!1,id:c})};e.prototype.parseUrl=function(a){a=a.split("?");var b=a[0].split("/mapserver/");this.host=b[0];this.servername=b[1].split("/")[1];a=a[1].split("\x26");for(b=0;b<a.length;b++){var c=a[b].split("\x3d");if("styleId"==c[0]){this.styleId=c[1];break}}};e.prototype.pickupFeatures=function(b,c,e,g,k,m,l,t){b=this.host+"/mapserver/pickup/"+this.servername+"/getData?x\x3d"+c+"\x26y\x3d"+b+"\x26l\x3d"+e+"\x26pixelX\x3d"+g+"\x26pixelY\x3d"+k+"\x26styleId\x3d"+this.styleId+"\x26tilesize\x3d"+this.tileSize+"\x26clientVersion\x3d"+a;m&&(b=b+"\x26control\x3d"+m);l&&(b=b+"\x26controlId\x3d"+l);f({url:b,dataType:"json"}).then(function(a){t(a)},function(){t([])})};e.prototype.CreateHighlightFilter=function(a,e){var d=new c;d.otherDisplay=!1;for(var f in a){var g=a[f],n=!1,l;for(l in g)g=new b,g.id=f,g.idFilter=l,g.color=e,d.addFilterLayer(g),n=!0;n||(g=new b,g.id=f,g.color=e,d.addFilterLayer(g))}return d};e.prototype.CreateEveryHighlightFilter=function(a){var d=new c;d.otherDisplay=!1;for(var e in a){var f=a[e],g=f.style,m=!1,l;for(l in f){m=f[l].style;m.color=m.color.replace("#","%23");var t=new b;t.id=e;t.idFilter=l;t.color=m;d.addFilterLayer(t);m=!0}!m&&g&&(g.color=g.color.replace("#","%23"),t=new b,t.id=e,t.color=g,d.addFilterLayer(t))}return d};e.prototype.isIE=function(){return window.ActiveXObject||"ActiveXObject"in window?!0:!1};return e}();l.exports=g},{"../../../ext/Version":3,"./../../../filter/Filter":4,"./../../../filter/FilterLayer":5,"./../../../utils/es6-promise":33}],28:[function(g,l,r){g=function(){function f(c){_classCallCheck(this,f);this.group={};this.group.id=c;this.group.type="group";this.group.children=[]}f.prototype.addStyle=function(c){this.group.children.push(c.style)};return f}();l.exports=g},{}],29:[function(g,l,r){g=function(){function f(c,b){_classCallCheck(this,f);this.levelsData=[];this.levelsKey=c+"-"+b}f.prototype.addGroup=function(c){this.levelsData.push(c.group)};f.prototype.addStyleItem=function(c){this.levelsData.push(c.style)};return f}();l.exports=g},{}],30:[function(g,l,r){g=function(){function f(c,b){_classCallCheck(this,f);this.style={};this.style.id=c;this.style.layer=b;this.style.type="style";this.style.children=[]}f.prototype.queryFilter=function(c,b){c?(this.style.query=c,this.style.fields=b):this.style.query=""};f.prototype.setStyle=function(c){this.style.style=c};f.prototype.addSubStyle=function(c){this.style.children.push(c.style)};return f}();l.exports=g},{}],31:[function(g,l,r){g=function(){function f(c){_classCallCheck(this,f);this.size=c;this.map={};this.list=[]}f.prototype.push=function(c,b){if(this.list.length>this.size-1){var a=this.list.shift();delete this.map[a]}this.list.push(c);this.map[c]=b};f.prototype.getItem=function(c){return this.map[c]};f.prototype.clean=function(){this.map={};this.list=[]};f.prototype.length=function(){return this.list.length};return f}();l.exports=g},{}],32:[function(g,l,r){function f(){this.id=this.createUUID()}f.prototype.valueOf=function(){return this.id};f.prototype.toString=function(){return this.id};f.prototype.createUUID=function(){var c=new Date(1582,10,15,0,0,0,0),b=(new Date).getTime()-c.getTime(),c=f.getIntegerBits(b,0,31),a=f.getIntegerBits(b,32,47),b=f.getIntegerBits(b,48,59)+"2",e=f.getIntegerBits(f.rand(4095),0,7),d=f.getIntegerBits(f.rand(4095),0,7),g=f.getIntegerBits(f.rand(8191),0,7)+f.getIntegerBits(f.rand(8191),8,15)+f.getIntegerBits(f.rand(8191),0,7)+f.getIntegerBits(f.rand(8191),8,15)+f.getIntegerBits(f.rand(8191),0,15);return c+a+b+e+d+g};f.getIntegerBits=function(c,b,a){c=f.returnBase(c,16);var e=[],d="",g;for(g=0;g<c.length;g++)e.push(c.substring(g,g+1));for(g=Math.floor(b/4);g<=Math.floor(a/4);g++)d=e[g]&&""!=e[g]?d+e[g]:d+"0";return d};f.returnBase=function(c,b){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");if(c<b)a=a[c];else var e=""+Math.floor(c/b),d=c-e*b,a=e>=b?this.returnBase(e,b)+a[d]:a[e]+a[d];return a};f.rand=function(c){return Math.floor(Math.random()*c)};l.exports=f},{}],33:[function(g,l,r){(function(f,c){var b=function(){function a(){return function(){return f.nextTick(h)}}function b(){return"undefined"!==typeof W?function(){W(h)}:l()}function d(){var a=0,b=new Z(h),c=document.createTextNode("");b.observe(c,{characterData:!0});return function(){c.data=a=++a%2}}function n(){var a=new MessageChannel;a.port1.onmessage=h;return function(){return a.port2.postMessage(0)}}function l(){var a=setTimeout;return function(){return a(h,1)}}function h(){for(var a=0;a<H;a+=2)(0,I[a])(I[a+1]),I[a]=void 0,I[a+1]=void 0;H=0}function k(){try{var a=g("vertx");W=a.runOnLoop||a.runOnContext;return b()}catch(aa){return l()}}function m(a,b){var c=arguments,d=this,e=new this.constructor(t);void 0===e[S]&&R(e);var f=d._state;f?function(){var a=c[f-1];F(function(){return Q(f,e,a,d._result)})}():M(d,e,a,b);return e}function q(a){if(a&&"object"===("undefined"===typeof a?"undefined":_typeof(a))&&a.constructor===this)return a;var b=new this(t);u(b,a);return b}function t(){}function r(a){try{return a.then}catch(aa){return O.error=aa,O}}function v(a,b,c,d){try{a.call(b,c,d)}catch(ga){return ga}}function U(a,b,c){F(function(a){var d=!1,e=v(c,b,function(c){d||(d=!0,b!==c?u(a,c):w(a,c))},function(b){d||(d=!0,x(a,b))},"Settle: "+(a._label||" unknown promise"));!d&&e&&(d=!0,x(a,e))},a)}function C(a,b){b._state===P?w(a,b._result):b._state===J?x(a,b._result):M(b,void 0,function(b){return u(a,b)},function(b){return x(a,b)})}function G(a,b,c){b.constructor===a.constructor&&c===m&&b.constructor.resolve===q?C(a,b):c===O?(x(a,O.error),O.error=null):void 0===c?w(a,b):"function"===typeof c?U(a,b,c):w(a,b)}function u(a,b){if(a===b)x(a,new TypeError("You cannot resolve a promise with itself"));else{var c="undefined"===typeof b?"undefined":_typeof(b);null===b||"object"!==c&&"function"!==c?w(a,b):G(a,b,r(b))}}function y(a){a._onerror&&a._onerror(a._result);N(a)}function w(a,b){a._state===K&&(a._result=b,a._state=P,0!==a._subscribers.length&&F(N,a))}function x(a,b){a._state===K&&(a._state=J,a._result=b,F(y,a))}function M(a,b,c,d){var e=a._subscribers,f=e.length;a._onerror=null;e[f]=b;e[f+P]=c;e[f+J]=d;0===f&&a._state&&F(N,a)}function N(a){var b=a._subscribers,c=a._state;if(0!==b.length){for(var d,e,f=a._result,g=0;g<b.length;g+=3)d=b[g],e=b[g+c],d?Q(c,d,e,f):e(f);a._subscribers.length=0}}function E(){this.error=null}function Q(a,b,c,d){var e="function"===typeof c,f=void 0,g=void 0,h=void 0;if(e){if(c=c(d),c===ha?(h=!0,f=c.error,c.error=null):g=!0,b===c){x(b,new TypeError("A promises callback cannot return that same promise."));return}}else c=d,g=!0;b._state===K&&(e&&g?u(b,c):h?x(b,f):a===P?w(b,c):a===J&&x(b,c))}function V(a,b){try{b(function(b){u(a,b)},function(b){x(a,b)})}catch(ea){x(a,ea)}}function R(a){a[S]=ba++;a._state=void 0;a._result=void 0;a._subscribers=[]}function D(a,b){this._instanceConstructor=a;this.promise=new a(t);this.promise[S]||R(this.promise);ca(b)?(this._remaining=this.length=b.length,this._result=Array(this.length),0===this.length?w(this.promise,this._result):(this.length=this.length||0,this._enumerate(b),0===this._remaining&&w(this.promise,this._result))):x(this.promise,Error("Array Methods must be provided an Array"))}function A(a){this[S]=ba++;this._result=this._state=void 0;this._subscribers=[];if(t!==a){if("function"!==typeof a)throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(this instanceof A)V(this,a);else throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");}}var X=void 0,ca=X=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},H=0,W=void 0,Y=void 0,F=function(a,b){I[H]=a;I[H+1]=b;H+=2;2===H&&(Y?Y(h):da())},T=(X="undefined"!==typeof window?window:void 0)||{},Z=T.MutationObserver||T.WebKitMutationObserver,T="undefined"===typeof self&&"undefined"!==typeof f&&"[object process]"==={}.toString.call(f),ia="undefined"!==typeof Uint8ClampedArray&&"undefined"!==typeof importScripts&&"undefined"!==typeof MessageChannel,I=Array(1E3),da=void 0,da=T?a():Z?d():ia?n():void 0===X&&"function"===typeof g?k():l(),S=Math.random().toString(36).substring(16),K=void 0,P=1,J=2,O=new E,ha=new E,ba=0;D.prototype._enumerate=function(a){for(var b=0;this._state===K&&b<a.length;b++)this._eachEntry(a[b],b)};D.prototype._eachEntry=function(a,b){var c=this._instanceConstructor,d=c.resolve;d===q?(d=r(a),d===m&&a._state!==K?this._settledAt(a._state,b,a._result):"function"!==typeof d?(this._remaining--,this._result[b]=a):c===A?(c=new c(t),G(c,a,d),this._willSettleAt(c,b)):this._willSettleAt(new c(function(b){return b(a)}),b)):this._willSettleAt(d(a),b)};D.prototype._settledAt=function(a,b,c){var d=this.promise;d._state===K&&(this._remaining--,a===J?x(d,c):this._result[b]=c);0===this._remaining&&w(d,this._result)};D.prototype._willSettleAt=function(a,b){var c=this;M(a,void 0,function(a){return c._settledAt(P,b,a)},function(a){return c._settledAt(J,b,a)})};A.all=function(a){return(new D(this,a)).promise};A.race=function(a){var b=this;return ca(a)?new b(function(c,d){for(var e=a.length,f=0;f<e;f++)b.resolve(a[f]).then(c,d)}):new b(function(a,b){return b(new TypeError("You must pass an array to race."))})};A.resolve=q;A.reject=function(a){var b=new this(t);x(b,a);return b};A._setScheduler=function(a){Y=a};A._setAsap=function(a){F=a};A._asap=F;A.prototype={constructor:A,then:m,"catch":function(a){return this.then(null,a)}};A.polyfill=function(){var a=void 0;if("undefined"!==typeof c)a=c;else if("undefined"!==typeof self)a=self;else try{a=Function("return this")()}catch(fa){throw Error("polyfill failed because global object is unavailable in this environment");}var b=a.Promise;if(b){var d=null;try{d=Object.prototype.toString.call(b.resolve())}catch(fa){}if("[object Promise]"===d&&!b.cast)return}a.Promise=A};return A.Promise=A}().Promise;l.exports={Promise:b,Deferred:function(){this.promise=new b(function(a,b){this.resolve=a;this.reject=b}.bind(this));this.then=this.promise.then.bind(this.promise);this["catch"]=this.promise["catch"].bind(this.promise)},getJSON:function(a){a.type||(a.type="GET");a.dataType||(a.dataType="json");return new b(function(b,c){var d=new XMLHttpRequest;d.overrideMimeType&&d.overrideMimeType("text/html");d.open(a.type,a.url);d.onreadystatechange=function(){if(this.readyState===this.DONE)if(200===this.status){var d=this.responseText;"json"==a.dataType&&"string"==typeof d&&(d=JSON.parse(d));b(d)}else c(Error("getJSON: "+a.url+" failed with status: ["+this.status+"]"))};d.responseType="text";"GET"==a.type.toUpperCase()&&d.setRequestHeader("Content-Type","text/plain; charset\x3dutf-8");"POST"==a.type.toUpperCase()&&d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");d.send(a.data)})},getParamJSON:function(a){a.type||(a.type="GET");a.dataType||(a.dataType="json");var c=new XMLHttpRequest,d=new b(function(b,d){c.overrideMimeType&&c.overrideMimeType("text/html");var e=!1;setTimeout(function(){"200"!=c.status&&(e=!0,c.abort())},3E4);c.open(a.type,a.url);c.onreadystatechange=function(){if(e)d({param:a,data:"getParamJSON: "+a.url+" timeout"});else if(this.readyState===this.DONE)if(200===this.status){var c=this.responseText;"json"==a.dataType&&"string"==typeof c&&(c=JSON.parse(c));b({param:a,data:c})}else d({param:a,data:"getParamJSON: "+a.url+" failed with status: ["+this.status+"]"})};c.responseType="text";"GET"==a.type.toUpperCase()&&c.setRequestHeader("Content-Type","text/plain; charset\x3dutf-8");"POST"==a.type.toUpperCase()&&c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");c.send(a.data)});d.xhr=c;return d}}}).call(this,g("_process"),"undefined"!==typeof global?global:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{})},{_process:36}],34:[function(g,l,r){g=function(){function f(c,b,a,e,d,g){_classCallCheck(this,f);d=5*d/100;this.left=c-d;this.right=b+d;this.bottom=a-d;this.top=e+d;this.previous=f.createEmptyDoubleArray();this.now=f.createEmptyDoubleArray();this.question=f.createEmptyDoubleArray();this.point_question_quadrant=this.point_now_quadrant=this.point_previous_quadrant=-1}f.createEmptyDoubleArray=function(){return[NaN,NaN]};f.prototype.copy=function(c,b){b[0]=c[0];b[1]=c[1]};f.isEmpty=function(c){return null==c?!0:isNaN(c[0])||isNaN(c[1])?!0:!1};f.prototype.isQuadrant=function(c){var b=c[0];c=c[1];return b<this.left?c>this.top?8:c<this.bottom?2:1:b>this.right?c>this.top?6:c<this.bottom?4:5:c>this.top?7:c<this.bottom?3:9};f.prototype.passrule=function(c,b){return 1==c?1==b||2==b||8==b?2:1:2==c?1==b||2==b||8==b||3==b||4==b?2:1:3==this.point_previous_quadrant?2==this.point_now_quadrant||3==this.point_now_quadrant||4==this.point_now_quadrant?2:1:4==c?2==b||3==b||4==b||5==b||6==b?2:1:5==c?4==b||5==b||6==b?2:1:6==c?4==b||5==b||6==b||7==b||8==b?2:1:7==c?6==b||7==b||8==b?2:1:8==c?6==b||7==b||8==b||1==b||2==b?2:1:1};f.prototype.reset=function(){this.previous[0]=NaN;this.previous[1]=NaN;this.question[0]=NaN;this.question[1]=NaN;this.now[0]=NaN;this.now[1]=NaN;this.point_question_quadrant=this.point_now_quadrant=this.point_previous_quadrant=-1};f.prototype["in"]=function(c){return c[0]<this.left||c[0]>this.right||c[1]<this.bottom||c[1]>this.top?!1:!0};f.length=function(c,b,a,e){c=a-c;b=e-b;return Math.sqrt(c*c+b*b)};f.prototype.push=function(c,b){this.now[0]=c;this.now[1]=b;if(f.isEmpty(this.previous))return this.copy(this.now,this.previous),this.point_previous_quadrant=this.isQuadrant(this.now),[this.now];this.point_now_quadrant=this.isQuadrant(this.now);var a=this.passrule(this.point_previous_quadrant,this.point_now_quadrant);if(1==a){this.point_previous_quadrant=this.isQuadrant(this.now);this.copy(this.now,this.previous);if(f.isEmpty(this.question))return[this.now];a=[];this.copy(this.question,a);this.question=f.createEmptyDoubleArray();return[a,this.now]}if(2==a){if(!f.isEmpty(this.question)&&(a=this.passrule(this.point_question_quadrant,this.point_now_quadrant),1==a))return a=[],this.copy(this.question,a),this.question=f.createEmptyDoubleArray(),[a,this.now];this.copy(this.now,this.question);this.point_question_quadrant=this.point_now_quadrant}return null};return f}();l.exports=g},{}],35:[function(g,l,r){g=function(){function f(){_classCallCheck(this,f)}f.pointDistToLine=function(c,b,a,e,d,f){var g=((c-a)*(d-a)+(b-e)*(f-e))/((a-d)*(a-d)+(e-f)*(e-f));a+=g*(d-a);e+=g*(f-e);return Math.sqrt((c-a)*(c-a)+(b-e)*(b-e))};f.isPointOnSegment=function(c,b,a,e,d,g){return c-3>a&&c+3>d||c+3<a&&c-3<d||b-3>e&&b+3>g||b+3<e&&b-3<g?0:3>f.pointDistToLine(c,b,a,e,d,g)?1:0};f.pointInLine=function(c,b,a){var e=[];Array.isArray(a[0])?e=a:e.push(a);for(a=0;a<e.length;a++)for(var d=e[a],g=d.length/2,l=0;l<g-1;l++){var h;h=l+1;if(1==f.isPointOnSegment(c,b,d[2*l],d[2*l+1],d[2*h],d[2*h+1]))return 1}return 0};f.pointInPolygon=function(c,b,a){var e=0,d=[];Array.isArray(a[0])?d=a:d.push(a);for(a=0;a<d.length;a++)for(var f=d[a],g=0,h=f.length/2,k=h-1;g<h;k=g,g++){var m=f[2*g],l=f[2*g+1],r=f[2*k],k=f[2*k+1];if(m===c&&l===b||r===c&&k===b)return 1;if(l<b&&k>=b||l>=b&&k<b){m+=(b-l)*(r-m)/(k-l);if(m===c)return 1;m>c&&(e=!e)}}return e?1:0};f.lineIntersects=function(c,b,a,e,d,f,g,h){var k,m,l,n,p=[null,null];k=(h-f)*(a-c)-(g-d)*(e-b);if(0===k)return null!==p[0]&&null!==p[1]?p:!1;m=b-f;l=c-d;n=(a-c)*m-(e-b)*l;m=((g-d)*m-(h-f)*l)/k;l=n/k;p[0]=c+m*(a-c);p[1]=b+m*(e-b);return 0<l&&1>l?p:!1};f.polyWith=function(c,b){for(var a=c.length/2,e=b.length/2,d,g,l,h,k,m,q,r,B=0;B<a;B++){B!=a-1?(g=c[2*B],l=c[2*B+1],h=c[2*B+2],d=c[2*B+3]):(g=c[2*B],l=c[2*B+1],h=c[0],d=c[1]);for(var v=0;v<e;v++)if(v!=e-1?(m=b[2*v],q=b[2*v+1],r=b[2*v+2],k=b[2*v+3]):(m=b[2*v],q=b[2*v+1],r=b[0],k=b[1]),0!=f.lineIntersects(g,l,h,d,m,q,r,k))return 1}return f.pointInPolygon(b[0],b[1],c)?2:3};f.boxToPolyArr=function(c,b,a,e){var d=[];d.push(c);d.push(b);d.push(c);d.push(e);d.push(a);d.push(e);d.push(a);d.push(b);d.push(c);d.push(b);return d};f.getExtensionPoint=function(c,b,a){var e=b[0]-c[0],d=b[1]-c[1];c=b[0];0==e?b=0<d?b[1]+a:b[1]-a:(a=Math.sqrt(a*a/(d/e*(d/e)+1)),0>e&&(a=-a),c=b[0]+a,b=b[1]+d/e*a);return[c,b]};return f}();l.exports=g},{}],36:[function(g,l,r){function f(){throw Error("setTimeout has not been defined");}function c(){throw Error("clearTimeout has not been defined");}function b(a){if(h===setTimeout)return setTimeout(a,0);if((h===f||!h)&&setTimeout)return h=setTimeout,setTimeout(a,0);try{return h(a,0)}catch(U){try{return h.call(null,a,0)}catch(C){return h.call(this,a,0)}}}function a(a){if(k===clearTimeout)return clearTimeout(a);if((k===c||!k)&&clearTimeout)return k=clearTimeout,clearTimeout(a);try{return k(a)}catch(U){try{return k.call(null,a)}catch(C){return k.call(this,a)}}}function e(){q&&t&&(q=!1,t.length?m=t.concat(m):B=-1,m.length&&d())}function d(){if(!q){var c=b(e);q=!0;for(var d=m.length;d;){t=m;for(m=[];++B<d;)t&&t[B].run();B=-1;d=m.length}t=null;q=!1;a(c)}}function n(a,b){this.fun=a;this.array=b}function p(){}g=l.exports={};var h,k;try{h="function"===typeof setTimeout?setTimeout:f}catch(v){h=f}try{k="function"===typeof clearTimeout?clearTimeout:c}catch(v){k=c}var m=[],q=!1,t,B=-1;g.nextTick=function(a){var c=Array(arguments.length-1);if(1<arguments.length)for(var e=1;e<arguments.length;e++)c[e-1]=arguments[e];m.push(new n(a,c));1!==m.length||q||b(d)};n.prototype.run=function(){this.fun.apply(null,this.array)};g.title="browser";g.browser=!0;g.env={};g.argv=[];g.version="";g.versions={};g.on=p;g.addListener=p;g.once=p;g.off=p;g.removeListener=p;g.removeAllListeners=p;g.emit=p;g.prependListener=p;g.prependOnceListener=p;g.listeners=function(a){return[]};g.binding=function(a){throw Error("process.binding is not supported");};g.cwd=function(){return"/"};g.chdir=function(a){throw Error("process.chdir is not supported");};g.umask=function(){return 0}},{}]},{},[6])(6)});